<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allencai's Command Center</title>
    <style>
        /* --- 1. æ ¸å¿ƒé…è‰²å˜é‡ --- */
        :root {
            --bg-dark: #0f1016;
            --card-glass: rgba(30, 32, 45, 0.6); /* ç¨å¾®è°ƒæ·±ä¸€ç‚¹ï¼Œå¢åŠ é˜…è¯»å¯¹æ¯”åº¦ */
            --card-border: rgba(255, 255, 255, 0.1);
            --text-main: #f0f4f8;
            --text-dim: #94a3b8;
            --text-light: #e2e8f0;
            --accent-cyan: #00f2ff;
            --accent-purple: #bd00ff;
            --danger: #ff4757;
            --active-item-bg: rgba(0, 242, 255, 0.15);
            --player-controls-bg: rgba(20, 22, 35, 0.8);
            --player-controls-border: rgba(0, 242, 255, 0.3);
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: 
                linear-gradient(135deg, rgba(11, 16, 33, 0.85) 0%, rgba(10, 10, 10, 0.95) 100%),
                url('/static/bg.jpg'); 
            background-size: cover; background-position: center; background-attachment: fixed;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        .container {
            width: 92%; max-width: 1500px;
            display: grid; 
            grid-template-columns: 2.8fr 1.5fr; 
            gap: 2rem; 
            padding: 2rem 0;
            height: 90vh;
        }

        /* éŸ³ä¹æ’­æ”¾å™¨é¢æ¿æ ·å¼ */
        .music-player {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 400px;
            background: var(--player-controls-bg);
            border: 1px solid var(--player-controls-border);
            border-radius: 12px;
            padding: 0.8rem;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            max-height: 400px;
            overflow: hidden;
        }

        .music-player.minimized {
            max-height: 80px;
        }

        .music-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .playback-mode {
            display: flex;
            gap: 0.5rem;
        }

        .playback-mode-btn {
            padding: 0.25rem 0.6rem;
            background: rgba(0, 242, 255, 0.1);
            border: 1px solid var(--accent-cyan);
            border-radius: 15px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }

        .playback-mode-btn.active {
            background: var(--accent-cyan);
            color: #000;
        }

        .current-playlist {
            font-size: 0.95rem;
            font-weight: bold;
            color: var(--accent-cyan);
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .player-btn {
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .player-btn:hover {
            background: rgba(0, 242, 255, 0.2);
            transform: scale(1.05);
        }

        .player-btn.play-pause {
            background: var(--accent-cyan);
            color: #000;
            font-size: 1.4rem;
        }

        .progress-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .progress-bar {
            flex-grow: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .progress {
            height: 100%;
            width: 0%;
            background: var(--accent-cyan);
            border-radius: 2px;
        }

        .current-song-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            min-width: 150px;
        }

        .current-song-title {
            font-size: 0.9rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .current-song-artist {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* æ’­æ”¾åˆ—è¡¨é€‰æ‹©å™¨ */
        .playlist-selector {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.6rem;
            flex-wrap: wrap;
            max-height: 35px;
            overflow-x: auto;
            padding-bottom: 3px;
        }

        .playlist-btn {
            padding: 0.3rem 0.6rem;
            background: rgba(30, 32, 45, 0.6);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .playlist-btn:hover, .playlist-btn.active {
            background: rgba(0, 242, 255, 0.2);
            border-color: var(--accent-cyan);
        }

        /* æ­Œæ›²åˆ—è¡¨æ ·å¼ */
        .songs-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 0.6rem;
            background: var(--card-glass);
            border-radius: 6px;
            padding: 0.3rem;
        }

        .song-item {
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .song-item:hover {
            background: rgba(0, 242, 255, 0.1);
        }

        .song-item.playing {
            background: rgba(0, 242, 255, 0.2);
            border-left: 2px solid var(--accent-cyan);
        }

        .song-title {
            font-weight: 500;
        }

        .song-duration {
            color: var(--text-dim);
            font-size: 0.8rem;
        }

        /* éŸ³ä¹æ’­æ”¾å™¨æœ€å°åŒ–/æœ€å¤§åŒ–æŒ‰é’® */
        .window-control-btn {
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 1rem;
            cursor: pointer;
            width: 25px;
            height: 25px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-left: 0.3rem;
        }

        .window-control-btn:hover {
            background: rgba(0, 242, 255, 0.2);
        }

        /* éŸ³ä¹æ’­æ”¾å™¨å›¾æ ‡ - å§‹ç»ˆæ˜¾ç¤ºåœ¨åº•éƒ¨ */
        .music-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            background: var(--accent-cyan);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 242, 255, 0.3);
            transition: all 0.3s;
        }

        .music-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 242, 255, 0.4);
        }

        .music-icon i {
            color: #000;
            font-size: 1.3rem;
        }

        /* è°ƒæ•´å¤§å°æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            cursor: nwse-resize;
            background: var(--accent-cyan);
            border-radius: 2px;
            z-index: 1001;
        }

        /* å·¦ä¾§é¢æ¿ï¼šå¯¼èˆªåŒº */
        .left-panel {
            display: flex; flex-direction: column; gap: 1.5rem;
            overflow-y: auto; padding-right: 5px;
        }

        .header-section {
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 1.5rem 2rem;
            background: var(--card-glass); backdrop-filter: blur(12px);
            border: 1px solid var(--card-border); border-radius: 16px;
        }
        .time-box h1 { font-size: 3.5rem; margin: 0; line-height: 1; font-weight: 700; letter-spacing: -2px; }
        .time-box p { font-size: 1.1rem; color: var(--text-dim); margin: 5px 0 0 0; }
        .greeting { font-size: 1.2rem; color: var(--accent-cyan); font-weight: 600; }

        .section-title {
            font-size: 0.9rem; color: var(--text-dim); margin-bottom: 0.5rem;
            display: flex; align-items: center; gap: 0.5rem;
            text-transform: uppercase; letter-spacing: 1px; font-weight: 700;
        }
        .section-title::after {
            content: ''; flex-grow: 1; height: 1px; 
            background: linear-gradient(to right, var(--card-border), transparent);
        }

        .nav-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem; margin-bottom: 1rem; min-height: 100px; padding: 5px;
        }

        .nav-item {
            background: var(--card-glass); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 1.2rem;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; transition: all 0.2s; user-select: none;
        }
        .nav-item:hover {
            border-color: var(--accent-cyan); transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .nav-item.dragging { opacity: 0.4; border: 1px dashed var(--accent-cyan); }
        .nav-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .nav-title { font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }

        .add-btn {
            border: 2px dashed var(--card-border); color: var(--text-dim);
            min-height: 100px; display: flex; align-items: center; justify-content: center;
            border-radius: 12px; cursor: pointer; flex-direction: column; transition: 0.3s;
        }
        .add-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); background: rgba(0,242,255,0.05); }

        .delete-btn {
            position: absolute; top: 5px; right: 5px; width: 18px; height: 18px;
            background: var(--danger); color: white; border-radius: 50%;
            display: none; align-items: center; justify-content: center; font-size: 10px; border: none; cursor: pointer;
        }
        .nav-item:hover .delete-btn { display: flex; }

        /* å³ä¾§é¢æ¿ï¼šç¬”è®°æœ¬ç³»ç»Ÿ (å‡çº§æ ¸å¿ƒ) */
        .right-panel { height: 100%; }
        
        .notebook-container {
            background: var(--card-glass); backdrop-filter: blur(12px);
            border: 1px solid var(--card-border); border-radius: 16px;
            height: 100%; display: flex; overflow: hidden;
        }

        /* ç¬”è®°æœ¬ï¼šå·¦ä¾§åˆ—è¡¨æ  */
        .note-sidebar {
            width: 200px; background: rgba(0,0,0,0.2);
            border-right: 1px solid var(--card-border);
            display: flex; flex-direction: column;
        }
        .sidebar-header {
            padding: 1rem; border-bottom: 1px solid var(--card-border);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem; font-weight: bold; color: var(--text-dim);
        }
        .new-note-btn {
            background: none; border: none; color: var(--accent-cyan);
            font-size: 1.2rem; cursor: pointer; transition: 0.2s;
        }
        .new-note-btn:hover { transform: scale(1.1); color: #fff; }

        .note-list {
            flex-grow: 1; overflow-y: auto; padding: 0.5rem;
        }
        .note-list-item {
            padding: 10px 12px; margin-bottom: 5px; border-radius: 8px;
            cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .note-list-item:hover { background: rgba(255,255,255,0.05); }
        .note-list-item.active {
            background: var(--active-item-bg);
            border-left: 3px solid var(--accent-cyan);
        }
        .note-item-title {
            font-size: 0.9rem; color: var(--text-main);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 130px;
        }
        .note-item-date { font-size: 0.7rem; color: var(--text-dim); }
        
        .del-note-btn {
            opacity: 0; color: var(--text-dim); font-size: 0.8rem;
            cursor: pointer; margin-left: 5px;
        }
        .note-list-item:hover .del-note-btn { opacity: 1; }
        .del-note-btn:hover { color: var(--danger); }

        /* ç¬”è®°æœ¬ï¼šå³ä¾§ç¼–è¾‘åŒº */
        .note-editor {
            flex-grow: 1; display: flex; flex-direction: column;
        }
        .editor-header {
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--card-border);
        }
        input.note-title-input {
            background: transparent; border: none;
            font-size: 1.4rem; font-weight: bold; color: var(--text-main);
            width: 100%; outline: none; padding: 5px 0;
            font-family: inherit;
        }
        input.note-title-input:focus { border-bottom: 1px solid var(--accent-cyan); }
        
        .note-meta-info {
            font-size: 0.8rem; color: var(--text-dim); margin-top: 5px;
            display: flex; gap: 15px;
        }

        textarea.note-content-area {
            flex-grow: 1; background: transparent; border: none;
            padding: 1.5rem; color: var(--text-main);
            font-size: 1rem; line-height: 1.7; resize: none; outline: none;
            font-family: inherit;
        }
        
        /* æ»šåŠ¨æ¡å‡ºç°åœ¨å†…å®¹åŒº */
        textarea.note-content-area::-webkit-scrollbar { width: 8px; }

        /* --- å¼¹çª— --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .modal {
            background: #15161c; border: 1px solid var(--card-border);
            padding: 2rem; border-radius: 16px; width: 320px;
        }
        .modal h3 { margin-top: 0; color: var(--accent-cyan); }
        .input-group { margin-bottom: 1rem; }
        .input-group input {
            width: 100%; padding: 10px; background: rgba(255,255,255,0.05);
            border: 1px solid var(--card-border); border-radius: 6px; color: white;
        }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 8px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        .btn-confirm { background: var(--accent-cyan); color: #000; }
        .btn-cancel { background: #333; color: #fff; }

        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; height: auto; display: block; }
            .left-panel { margin-bottom: 2rem; }
            .notebook-container { height: 600px; }
            .music-player {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
                bottom: 100px;
            }
            .music-icon {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="left-panel">
        <div class="header-section">
            <div class="time-box">
                <h1 id="clock">00:00</h1>
                <p id="date">Loading...</p>
            </div>
            <div class="greeting" id="greetingText">System Online</div>
        </div>

        <div>
            <div class="section-title">ğŸŒ å¸¸ç”¨ç½‘ç«™</div>
            <div class="nav-grid sortable-grid" id="webGrid"></div>
            <div class="add-btn" onclick="openModal('websites')"><span>â• æ·»åŠ ç½‘ç«™</span></div>
        </div>

        <div>
            <div class="section-title">ğŸ’» åº”ç”¨ç¨‹åº</div>
            <div class="nav-grid sortable-grid" id="appGrid"></div>
            <div class="add-btn" onclick="openModal('software')"><span>â• æ·»åŠ è½¯ä»¶</span></div>
        </div>
    </div>

    <!-- å³ä¾§é¢æ¿ï¼šç¬”è®°æœ¬ -->
    <div class="right-panel">
        <div class="notebook-container">
            <!-- ç¬”è®°åˆ—è¡¨ -->
            <div class="note-sidebar">
                <div class="sidebar-header">
                    <span>æˆ‘çš„ç¬”è®°æœ¬</span>
                    <button class="new-note-btn" onclick="createNewNote()" title="æ–°å»ºç¬”è®°">â•</button>
                </div>
                <div class="note-list" id="noteList">
                    <!-- JS ç”Ÿæˆåˆ—è¡¨é¡¹ -->
                </div>
            </div>

            <!-- ç¬”è®°ç¼–è¾‘åŒº -->
            <div class="note-editor">
                <div class="editor-header">
                    <input type="text" id="noteTitleInput" class="note-title-input" placeholder="æ— æ ‡é¢˜ç¬”è®°">
                    <div class="note-meta-info">
                        <span id="noteUpdateTime">æ›´æ–°äº: --</span>
                        <span id="noteCharCount">0 å­—</span>
                    </div>
                </div>
                <textarea id="noteContentInput" class="note-content-area" placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..."></textarea>
            </div>
        </div>
    </div>
</div>

<!-- éŸ³ä¹æ’­æ”¾å™¨ -->
<div class="music-player" id="musicPlayer" style="display: none;">
    <div class="music-player-header">
        <div class="current-playlist" id="currentPlaylist">æœªé€‰æ‹©æ’­æ”¾åˆ—è¡¨</div>
        <div style="display: flex; align-items: center;">
            <div class="playback-mode">
                <button class="playback-mode-btn active" data-mode="list" onclick="setPlaybackMode('list')">åˆ—è¡¨</button>
                <button class="playback-mode-btn" data-mode="repeat" onclick="setPlaybackMode('repeat')">å•æ›²</button>
                <button class="playback-mode-btn" data-mode="shuffle" onclick="setPlaybackMode('shuffle')">éšæœº</button>
            </div>
            <button class="window-control-btn" onclick="toggleMinimizePlayer()" title="æœ€å°åŒ–/è¿˜åŸ">âˆ’</button>
            <button class="window-control-btn" onclick="hideMusicPlayer()" title="éšè—">Ã—</button>
        </div>
    </div>
    
    <div class="playlist-selector" id="playlistSelector">
        <!-- æ’­æ”¾åˆ—è¡¨æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <div class="songs-list" id="songsList">
        <!-- æ­Œæ›²åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <div class="player-controls">
        <div class="current-song-info">
            <div class="current-song-title" id="currentSongTitle">è¯·é€‰æ‹©æ­Œæ›²</div>
            <div class="current-song-artist" id="currentSongArtist">æœªçŸ¥è‰ºæœ¯å®¶</div>
        </div>
        
        <div class="progress-container">
            <span id="currentTime">00:00</span>
            <div class="progress-bar" onclick="seekSong(event)">
                <div class="progress" id="progressBar"></div>
            </div>
            <span id="totalTime">00:00</span>
        </div>
        
        <button class="player-btn" onclick="prevSong()" title="ä¸Šä¸€é¦–">â®</button>
        <button class="player-btn play-pause" id="playPauseBtn" onclick="togglePlayPause()" title="æ’­æ”¾/æš‚åœ">â–¶</button>
        <button class="player-btn" onclick="nextSong()" title="ä¸‹ä¸€é¦–">â­</button>
    </div>
    
    <div class="resize-handle" id="resizeHandle"></div>
</div>

<!-- éŸ³ä¹æ’­æ”¾å™¨å›¾æ ‡ - å§‹ç»ˆæ˜¾ç¤ºåœ¨åº•éƒ¨ -->
<div class="music-icon" id="musicIcon" onclick="showMusicPlayer()" style="display: none;">
    <i>ğŸµ</i>
</div>

<!-- æ·»åŠ å¯¼èˆªçš„å¼¹çª— -->
<div class="modal-overlay" id="addModal">
    <div class="modal">
        <h3 id="modalTitle">æ·»åŠ æ–°é¡¹</h3>
        <input type="hidden" id="addType">
        <div class="input-group">
            <label>åç§°</label><input type="text" id="linkTitle">
        </div>
        <div class="input-group">
            <label>é“¾æ¥/è·¯å¾„</label><input type="text" id="linkUrl" placeholder="https:// æˆ– D:\xxx.exe">
        </div>
        <div class="input-group">
            <label>å›¾æ ‡</label><input type="text" id="linkIcon" placeholder="â¤ï¸">
        </div>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-confirm" onclick="confirmAdd()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    // --- éŸ³ä¹æ’­æ”¾å™¨ç›¸å…³å˜é‡ ---
    let audioPlayer = new Audio();
    let currentPlaylist = [];
    let currentSongIndex = -1;
    let playbackMode = 'list'; // 'list', 'repeat', 'shuffle'
    let playlists = [];
    let shuffledOrder = [];
    let shuffleIndex = 0;
    let isPlayerVisible = false;
    let isPlayerMinimized = false;
    let isResizing = false;
    let originalWidth = 400;
    let originalHeight = 400;
    
    // --- æ•°æ®ç»“æ„ ---
    let globalData = {
        websites: [],
        software: [],
        notes: [] // æ–°çš„ç¬”è®°æ•°ç»„ç»“æ„: [{id: 1, title: "xx", content: "xx", updated: "time"}]
    };
    
    let currentNoteId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘å“ªä¸ªç¬”è®°

    // --- 1. åŸºç¡€åŠŸèƒ½ (æ—¶é—´) ---
    function updateTime() {
        const now = new Date();
        document.getElementById('clock').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        document.getElementById('date').innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
        const h = now.getHours();
        document.getElementById('greetingText').innerText = `Allencaiï¼Œ${h<11?"ä¸Šåˆå¥½":h<13?"ä¸­åˆå¥½":h<18?"ä¸‹åˆå¥½":"æ™šä¸Šå¥½"}`;
    }
    setInterval(updateTime, 1000); updateTime();

    // --- 2. æ•°æ®åŠ è½½ä¸è¿ç§» ---
    async function loadData() {
        try {
            const res = await fetch('/api/get_data');
            const serverData = await res.json();

            // æ•°æ®è¿ç§»ï¼šå¦‚æœåªæœ‰æ—§ç‰ˆ memo (å­—ç¬¦ä¸²)ï¼Œè½¬æ¢æˆæ–°ç‰ˆ notes (æ•°ç»„)
            if (serverData.memo && (!serverData.notes || serverData.notes.length === 0)) {
                globalData.notes = [{
                    id: Date.now(),
                    title: 'é»˜è®¤ç¬”è®°',
                    content: serverData.memo,
                    updated: new Date().toLocaleString()
                }];
                // è¿ç§»å…¶ä»–æ•°æ®
                globalData.websites = serverData.websites || serverData.links || [];
                globalData.software = serverData.software || [];
            } else {
                globalData = serverData;
                // ç¡®ä¿å„é¡¹éƒ½ä¸ä¸ºç©º
                if(!globalData.notes) globalData.notes = [];
                if(!globalData.websites) globalData.websites = [];
                if(!globalData.software) globalData.software = [];
            }

            // åˆå§‹åŒ–ç•Œé¢
            renderAllNav();
            
            // å¦‚æœæœ‰ç¬”è®°ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªï¼›å¦‚æœæ²¡æœ‰ï¼Œæ–°å»ºä¸€ä¸ª
            if (globalData.notes.length === 0) {
                createNewNote(false); // false è¡¨ç¤ºä¸ç«‹å³ä¿å­˜ï¼Œç­‰ç”¨æˆ·è¾“å…¥
            } else {
                switchNote(globalData.notes[0].id);
            }
            renderNoteList();

        } catch(e) { console.error("åŠ è½½å¤±è´¥", e); }
    }

    // --- éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ– ---
    async function initMusicPlayer() {
        try {
            const response = await fetch('/api/get_music_playlists');
            playlists = await response.json();
            
            // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨é€‰æ‹©å™¨
            renderPlaylistSelector();
            
            // å§‹ç»ˆæ˜¾ç¤ºéŸ³ä¹å›¾æ ‡
            document.getElementById('musicIcon').style.display = 'flex';
            
            if (playlists.length > 0) {
                // é»˜è®¤ä¸è‡ªåŠ¨æ˜¾ç¤ºæ’­æ”¾å™¨ï¼Œåªæ˜¾ç¤ºå›¾æ ‡
                console.log("éŸ³ä¹æ’­æ”¾å™¨å·²åˆå§‹åŒ–ï¼Œç‚¹å‡»å³ä¸‹è§’ğŸµå›¾æ ‡æ‰“å¼€");
            } else {
                console.log("æ²¡æœ‰æ‰¾åˆ°éŸ³ä¹æ’­æ”¾åˆ—è¡¨");
            }
        } catch (error) {
            console.error("åŠ è½½éŸ³ä¹æ’­æ”¾åˆ—è¡¨å¤±è´¥:", error);
        }
    }

    function renderPlaylistSelector() {
        const container = document.getElementById('playlistSelector');
        container.innerHTML = '';
        
        playlists.forEach(playlist => {
            const button = document.createElement('button');
            button.className = 'playlist-btn';
            button.textContent = playlist.name;
            button.onclick = () => loadPlaylist(playlist.name);
            container.appendChild(button);
        });
    }

    function loadPlaylist(playlistName) {
        const playlist = playlists.find(p => p.name === playlistName);
        if (!playlist) return;
        
        currentPlaylist = playlist.songs;
        document.getElementById('currentPlaylist').textContent = playlistName;
        currentSongIndex = -1;
        renderSongsList();
        
        // æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.playlist-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === playlistName);
        });
    }

    function renderSongsList() {
        const container = document.getElementById('songsList');
        container.innerHTML = '';
        
        currentPlaylist.forEach((song, index) => {
            const songElement = document.createElement('div');
            songElement.className = `song-item ${index === currentSongIndex ? 'playing' : ''}`;
            songElement.onclick = () => playSong(index);
            songElement.innerHTML = `
                <div class="song-title">${song.title}</div>
                <div class="song-duration">--:--</div>
            `;
            container.appendChild(songElement);
        });
    }

    function playSong(index) {
        if (index < 0 || index >= currentPlaylist.length) return;
        
        currentSongIndex = index;
        const song = currentPlaylist[index];
        // ä½¿ç”¨æ–°çš„ç›¸å¯¹è·¯å¾„æ ¼å¼
        const songUrl = `/music/${encodeURIComponent(song.relative_path)}`;
        
        // è®¾ç½®éŸ³é¢‘æºå¹¶æ’­æ”¾
        audioPlayer.src = songUrl;
        audioPlayer.load(); // ç¡®ä¿é‡æ–°åŠ è½½éŸ³é¢‘
        audioPlayer.play().then(() => {
            document.getElementById('playPauseBtn').innerHTML = 'â¸'; // æš‚åœå›¾æ ‡
        }).catch(e => console.error("æ’­æ”¾å¤±è´¥:", e));
        
        // æ›´æ–°UI
        updatePlayerUI();
        renderSongsList();
    }

    function togglePlayPause() {
        if (audioPlayer.paused) {
            audioPlayer.play().then(() => {
                document.getElementById('playPauseBtn').innerHTML = 'â¸'; // æš‚åœå›¾æ ‡
            }).catch(e => console.error("æ’­æ”¾å¤±è´¥:", e));
        } else {
            audioPlayer.pause();
            document.getElementById('playPauseBtn').innerHTML = 'â–¶'; // æ’­æ”¾å›¾æ ‡
        }
    }

    function nextSong() {
        if (currentPlaylist.length === 0) return;
        
        if (playbackMode === 'repeat') {
            // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
            playSong(currentSongIndex);
        } else if (playbackMode === 'shuffle') {
            // éšæœºæ’­æ”¾æ¨¡å¼
            if (shuffledOrder.length === 0) {
                generateShuffledOrder();
            }
            shuffleIndex = (shuffleIndex + 1) % shuffledOrder.length;
            playSong(shuffledOrder[shuffleIndex]);
        } else {
            // åˆ—è¡¨é¡ºåºæ’­æ”¾
            const nextIndex = (currentSongIndex + 1) % currentPlaylist.length;
            playSong(nextIndex);
        }
    }

    function prevSong() {
        if (currentPlaylist.length === 0) return;
        
        if (playbackMode === 'repeat') {
            // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
            playSong(currentSongIndex);
        } else if (playbackMode === 'shuffle') {
            // éšæœºæ’­æ”¾æ¨¡å¼
            if (shuffledOrder.length === 0) {
                generateShuffledOrder();
            }
            shuffleIndex = shuffleIndex === 0 ? shuffledOrder.length - 1 : shuffleIndex - 1;
            playSong(shuffledOrder[shuffleIndex]);
        } else {
            // åˆ—è¡¨é¡ºåºæ’­æ”¾
            const prevIndex = currentSongIndex === 0 ? currentPlaylist.length - 1 : currentSongIndex - 1;
            playSong(prevIndex);
        }
    }

    function generateShuffledOrder() {
        // ç”Ÿæˆéšæœºæ’­æ”¾é¡ºåº
        shuffledOrder = Array.from(Array(currentPlaylist.length).keys());
        for (let i = shuffledOrder.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledOrder[i], shuffledOrder[j]] = [shuffledOrder[j], shuffledOrder[i]];
        }
        shuffleIndex = 0;
    }

    function setPlaybackMode(mode) {
        playbackMode = mode;
        document.querySelectorAll('.playback-mode-btn').forEach(btn => {
            if(btn.dataset.mode) {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            }
        });
    }

    function toggleMinimizePlayer() {
        const player = document.getElementById('musicPlayer');
        isPlayerMinimized = !isPlayerMinimized;
        
        if (isPlayerMinimized) {
            player.classList.add('minimized');
            document.querySelector('.window-control-btn').innerHTML = '+'; // å±•å¼€å›¾æ ‡
        } else {
            player.classList.remove('minimized');
            document.querySelector('.window-control-btn').innerHTML = 'âˆ’'; // æœ€å°åŒ–å›¾æ ‡
        }
    }

    function showMusicPlayer() {
        document.getElementById('musicPlayer').style.display = 'flex';
        isPlayerVisible = true;
        
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ˜¾ç¤ºï¼ŒåŠ è½½æ’­æ”¾åˆ—è¡¨
        if (playlists.length === 0) {
            initMusicPlayer();
        }
        
        // å¦‚æœæœ‰æ’­æ”¾åˆ—è¡¨ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ª
        if (playlists.length > 0 && currentPlaylist.length === 0) {
            loadPlaylist(playlists[0].name);
        }
    }

    function hideMusicPlayer() {
        document.getElementById('musicPlayer').style.display = 'none';
        isPlayerVisible = false;
    }

    function seekSong(event) {
        const progressBar = document.querySelector('.progress-bar');
        const rect = progressBar.getBoundingClientRect();
        const pos = (event.clientX - rect.left) / rect.width;
        audioPlayer.currentTime = pos * audioPlayer.duration;
    }

    function updatePlayerUI() {
        if (currentSongIndex >= 0 && currentSongIndex < currentPlaylist.length) {
            const song = currentPlaylist[currentSongIndex];
            document.getElementById('currentSongTitle').textContent = song.title;
            document.getElementById('currentSongArtist').textContent = document.getElementById('currentPlaylist').textContent;
        }
    }

    // éŸ³é¢‘äº‹ä»¶ç›‘å¬
    audioPlayer.addEventListener('loadedmetadata', function() {
        document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
    });

    audioPlayer.addEventListener('timeupdate', function() {
        document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
        const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        document.getElementById('progressBar').style.width = progressPercent + '%';
    });

    audioPlayer.addEventListener('ended', function() {
        nextSong();
    });

    audioPlayer.addEventListener('play', function() {
        document.getElementById('playPauseBtn').innerHTML = 'â¸';
    });

    audioPlayer.addEventListener('pause', function() {
        document.getElementById('playPauseBtn').innerHTML = 'â–¶';
    });

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    // è°ƒæ•´å¤§å°åŠŸèƒ½
    function initResize() {
        const resizeHandle = document.getElementById('resizeHandle');
        const player = document.getElementById('musicPlayer');
        
        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            e.preventDefault();
            originalWidth = player.offsetWidth;
            originalHeight = player.offsetHeight;
            document.addEventListener('mousemove', resizePlayer);
            document.addEventListener('mouseup', stopResize);
        });
    }

    function resizePlayer(e) {
        if (!isResizing) return;
        
        const player = document.getElementById('musicPlayer');
        const deltaX = e.movementX;
        const deltaY = e.movementY;
        
        let newWidth = originalWidth - deltaX;
        let newHeight = originalHeight - deltaY;
        
        // é™åˆ¶æœ€å°å°ºå¯¸
        newWidth = Math.max(300, newWidth);
        newHeight = Math.max(200, newHeight);
        
        player.style.width = newWidth + 'px';
        player.style.height = newHeight + 'px';
    }

    function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', resizePlayer);
        document.removeEventListener('mouseup', stopResize);
    }

    // --- 3. ç¬”è®°æœ¬é€»è¾‘ (æ ¸å¿ƒå‡çº§) ---

    // æ¸²æŸ“å·¦ä¾§ç¬”è®°åˆ—è¡¨
    function renderNoteList() {
        const listEl = document.getElementById('noteList');
        listEl.innerHTML = '';

        // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€è¿‘ä¿®æ”¹çš„åœ¨ä¸Šé¢ï¼‰
        const sortedNotes = [...globalData.notes].sort((a, b) => new Date(b.updated) - new Date(a.updated));

        sortedNotes.forEach(note => {
            const item = document.createElement('div');
            item.className = `note-list-item ${note.id === currentNoteId ? 'active' : ''}`;
            item.onclick = () => switchNote(note.id);
            
            // ç®€å•çš„æ—¥æœŸæ ¼å¼åŒ–
            const dateStr = note.updated ? note.updated.split(' ')[0] : 'åˆšåˆš';

            item.innerHTML = `
                <div style="overflow:hidden;">
                    <div class="note-item-title">${note.title || 'æ— æ ‡é¢˜'}</div>
                    <div class="note-item-date">${dateStr}</div>
                </div>
                <div class="del-note-btn" onclick="deleteNote(event, ${note.id})">ğŸ—‘ï¸</div>
            `;
            listEl.appendChild(item);
        });
    }

    // åˆ‡æ¢å½“å‰ç¬”è®°
    function switchNote(id) {
        currentNoteId = id;
        const note = globalData.notes.find(n => n.id === id);
        if (note) {
            document.getElementById('noteTitleInput').value = note.title;
            document.getElementById('noteContentInput').value = note.content;
            document.getElementById('noteUpdateTime').innerText = `æ›´æ–°äº: ${note.updated}`;
            updateCharCount(note.content);
            renderNoteList(); // åˆ·æ–°é€‰ä¸­çŠ¶æ€
        }
    }

    // æ–°å»ºç¬”è®°
    function createNewNote(autoSave = true) {
        const newNote = {
            id: Date.now(),
            title: 'æ–°ç¬”è®°',
            content: '',
            updated: new Date().toLocaleString()
        };
        globalData.notes.unshift(newNote); // åŠ åˆ°æœ€å‰é¢
        if (autoSave) saveData();
        
        switchNote(newNote.id);
        renderNoteList();
        // è‡ªåŠ¨èšç„¦æ ‡é¢˜
        document.getElementById('noteTitleInput').focus();
    }

    // åˆ é™¤ç¬”è®°
    function deleteNote(e, id) {
        e.stopPropagation(); // é˜»æ­¢è§¦å‘åˆ‡æ¢
        if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) {
            globalData.notes = globalData.notes.filter(n => n.id !== id);
            
            // å¦‚æœåˆ å…‰äº†ï¼Œè‡ªåŠ¨è¡¥ä¸€ä¸ª
            if (globalData.notes.length === 0) {
                createNewNote();
            } else {
                // å¦‚æœåˆ çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„ï¼Œå°±åˆ‡æ¢åˆ°ç¬¬ä¸€æ¡
                if (id === currentNoteId) {
                    switchNote(globalData.notes[0].id);
                }
                saveData();
                renderNoteList();
            }
        }
    }

    // ç›‘å¬è¾“å…¥ï¼Œè‡ªåŠ¨ä¿å­˜
    const titleInput = document.getElementById('noteTitleInput');
    const contentInput = document.getElementById('noteContentInput');

    function handleNoteInput() {
        const note = globalData.notes.find(n => n.id === currentNoteId);
        if (note) {
            note.title = titleInput.value;
            note.content = contentInput.value;
            note.updated = new Date().toLocaleString();
            
            // æ›´æ–°ç•Œé¢ä¸Šçš„æ—¶é—´å’Œå­—æ•°
            document.getElementById('noteUpdateTime').innerText = `æ›´æ–°äº: åˆšåˆš`;
            updateCharCount(note.content);
            
            // é˜²æŠ–ä¿å­˜åˆ°ç¡¬ç›˜
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(() => {
                saveData();
                renderNoteList(); // åˆ·æ–°åˆ—è¡¨é‡Œçš„æ ‡é¢˜å’Œæ—¶é—´
            }, 500);
        }
    }

    function updateCharCount(text) {
        document.getElementById('noteCharCount').innerText = `${text ? text.length : 0} å­—`;
    }

    titleInput.addEventListener('input', handleNoteInput);
    contentInput.addEventListener('input', handleNoteInput);

    // --- 4. å¯¼èˆªæ é€»è¾‘ (ä¿æŒä¸å˜) ---
    function renderAllNav() {
        renderGrid('webGrid', globalData.websites);
        renderGrid('appGrid', globalData.software);
    }
    
    function renderGrid(id, list) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        list.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'nav-item';
            div.draggable = true;
            div.innerHTML = `<button class="delete-btn">âœ•</button><div class="nav-icon">${item.icon}</div><div class="nav-title">${item.title}</div>`;
            div.onclick = (e) => {
                if(!e.target.classList.contains('delete-btn')) handleOpen(item.url);
            };
            div.querySelector('.delete-btn').onclick = () => {
                if(confirm('åˆ é™¤?')) { list.splice(idx, 1); saveData(); renderAllNav(); }
            };
            // ç®€å•æ‹–æ‹½
            div.addEventListener('dragstart', () => { div.classList.add('dragging'); window.dragItem = item; window.dragList = list; });
            div.addEventListener('dragend', () => { div.classList.remove('dragging'); saveData(); });
            el.appendChild(div);
        });
        
        // æ‹–æ‹½æ”¾å…¥é€»è¾‘
        el.addEventListener('dragover', e => { e.preventDefault(); });
        el.addEventListener('drop', () => {
            // ç®€åŒ–çš„åŒåˆ—è¡¨æ’åºï¼Œå®é™…è·¨åˆ—è¡¨éœ€è¦å¤æ‚é€»è¾‘ï¼Œæ­¤å¤„ä»…ä¸ºå ä½é˜²æ­¢æŠ¥é”™
            // è‹¥éœ€è¦å®Œæ•´æ‹–æ‹½ï¼Œè¯·å¤ç”¨ä¸Šä¸€ç‰ˆçš„ updateDataFromDOM é€»è¾‘
            saveData(); 
            renderAllNav();
        });
    }

    // --- 5. é€šç”¨ç½‘ç»œä¿å­˜ ---
    async function saveData() {
        await fetch('/api/save_data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(globalData)
        });
    }

    async function handleOpen(path) {
        if (path.startsWith('http')) window.open(path, '_blank');
        else fetch('/api/open_app', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({path}) });
    }

    // --- å¼¹çª—é€»è¾‘ ---
    let addTypeTarget = null;
    function openModal(type) { 
        document.getElementById('addModal').style.display = 'flex'; 
        addTypeTarget = type;
        document.getElementById('linkTitle').value='';
        document.getElementById('linkUrl').value='';
        document.getElementById('linkIcon').value='';
    }
    window.closeModal = () => document.getElementById('addModal').style.display='none';
    window.confirmAdd = () => {
        const title = document.getElementById('linkTitle').value;
        const url = document.getElementById('linkUrl').value;
        const icon = document.getElementById('linkIcon').value || 'ğŸ”—';
        if(title && url) {
            const list = addTypeTarget === 'websites' ? globalData.websites : globalData.software;
            list.push({title, url, icon});
            saveData(); renderAllNav(); closeModal();
        }
    }

    window.onload = () => {
        loadData();
        initMusicPlayer();
        initResize();
    };
</script>
</body>
</html>
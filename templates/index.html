<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allencai's Command Center</title>
    <style>
        /* --- 1. æ ¸å¿ƒé…è‰²å˜é‡ --- */
        :root {
            --bg-dark: #0a0b12;
            --card-glass: rgba(25, 27, 38, 0.85);
            --card-border: rgba(255, 255, 255, 0.15);
            --text-main: #f8fafc;
            --text-dim: #94a8c1;
            --text-light: #e6f0ff;
            --accent-cyan: #00e6ff;
            --accent-purple: #c700ff;
            --danger: #ff4d5a;
            --active-item-bg: rgba(0, 230, 255, 0.22);
            --player-controls-bg: rgba(18, 20, 32, 0.92);
            --player-controls-border: rgba(0, 230, 255, 0.4);
            --glow-intensity: 0 0 20px rgba(0, 230, 255, 0.3);
            --glow-subtle: 0 0 12px rgba(0, 230, 255, 0.15);
            --shadow-deep: 0 16px 40px rgba(0, 0, 0, 0.4);
            --shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.25);
            --shadow-light: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: 
                radial-gradient(circle at 15% 25%, rgba(0, 230, 255, 0.08) 0%, transparent 45%),
                radial-gradient(circle at 85% 75%, rgba(199, 0, 255, 0.08) 0%, transparent 45%),
                linear-gradient(135deg, rgba(8, 10, 18, 0.95) 0%, rgba(6, 6, 12, 0.98) 100%),
                url('/static/bg.jpg'); 
            background-size: cover; background-position: center; background-attachment: fixed;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(to bottom, var(--accent-cyan), var(--accent-purple)); 
            border-radius: 4px; 
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(to bottom, #00ccff, #b000e6); 
        }

        .container {
            width: 94%; max-width: 1520px;
            display: grid; 
            grid-template-columns: 2.8fr 1.5fr; 
            gap: 2.4rem; 
            padding: 2.4rem 0;
            height: 92vh;
            transition: grid-template-columns 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* å½“ body æœ‰æ­¤ç±»æ—¶æ”¾å¤§ç¬”è®°æœ¬æ ç›® */
        body.notebook-expanded .container {
            grid-template-columns: 1.2fr 3fr;
        }

        /* éŸ³ä¹æ’­æ”¾å™¨é¢æ¿æ ·å¼ */
        .music-player {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 420px;
            background: var(--player-controls-bg);
            border: 1px solid var(--player-controls-border);
            border-radius: 20px;
            padding: 1.2rem;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: var(--shadow-deep), var(--glow-intensity);
            max-height: 420px;
            overflow: hidden;
            backdrop-filter: blur(12px);
        }

        .music-player.minimized {
            max-height: 85px;
        }

        .music-player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .playback-mode {
            display: flex;
            gap: 0.8rem;
        }

        .playback-mode-btn {
            padding: 0.4rem 0.8rem;
            background: rgba(0, 230, 255, 0.15);
            border: 1px solid var(--accent-cyan);
            border-radius: 24px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .playback-mode-btn.active {
            background: var(--accent-cyan);
            color: #000;
            box-shadow: var(--glow-intensity);
            transform: translateY(-2px);
        }

        .current-playlist {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-cyan);
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 0 10px rgba(0, 230, 255, 0.4);
        }

        .player-controls {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .player-btn {
            background: rgba(255, 255, 255, 0.12);
            border: none;
            color: var(--text-main);
            font-size: 1.4rem;
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
        }

        .player-btn:hover {
            background: rgba(0, 230, 255, 0.3);
            transform: scale(1.15) translateY(-2px);
            box-shadow: var(--glow-intensity);
        }

        .player-btn.play-pause {
            background: var(--accent-cyan);
            color: #000;
            font-size: 1.6rem;
            box-shadow: var(--glow-intensity);
        }

        .progress-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-bar {
            flex-grow: 1;
            height: 12px;
            background: rgba(255, 255, 255, 0.18);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            opacity: 0.25;
            animation: pulse 2s infinite;
        }

        .progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .progress::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 6px;
            height: 100%;
            background: white;
            border-radius: 3px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        .current-song-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 180px;
        }

        .current-song-title {
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-light);
        }

        .current-song-artist {
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* æ’­æ”¾åˆ—è¡¨é€‰æ‹©å™¨ */
        .playlist-selector {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            max-height: 45px;
            overflow-x: auto;
            padding-bottom: 6px;
            scrollbar-width: thin;
        }

        /* ç¬”è®°åˆ†ç±»æ ï¼ˆæ°´å¹³ï¼‰ - ä¿æŒå•è¡Œæ¨ªå‘æ»šåŠ¨ï¼Œè°ƒé«˜é«˜åº¦ä¸æŒ‰é’®å†…è¾¹è· */
        #categoryList {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 1rem;
            /* ä¿æŒå•è¡Œï¼Œé¿å…æ¢è¡Œå¯¼è‡´çºµå‘æ»šåŠ¨ */
            flex-wrap: nowrap;
            /* è®¾å®šå›ºå®šé«˜åº¦ä¸ºåŸæ¥çš„ä¸‰å€ï¼ˆ40px -> 120pxï¼‰ */
            height: 80px;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
            scrollbar-width: thin;
            -webkit-overflow-scrolling: touch;
            white-space: nowrap;
        }

        #categoryList .playlist-btn {
            /* å‚ç›´å†…è¾¹è·å¢å¤§ä»¥é€‚é…æ›´é«˜çš„å®¹å™¨ï¼Œå¹¶å‚ç›´å±…ä¸­ */
            display: inline-flex;
            align-items: center;
            padding: 1.1rem 0.8rem;
            font-size: 1rem;
            white-space: nowrap;
        }

        .playlist-btn {
            padding: 0.4rem 0.8rem;
            background: var(--card-glass);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            white-space: nowrap;
            backdrop-filter: blur(8px);
            font-weight: 600;
        }

        .playlist-btn:hover, .playlist-btn.active {
            background: rgba(0, 230, 255, 0.3);
            border-color: var(--accent-cyan);
            transform: translateY(-3px);
            box-shadow: var(--glow-intensity);
        }

        /* æ­Œæ›²åˆ—è¡¨æ ·å¼ */
        .songs-list {
            max-height: 220px;
            overflow-y: auto;
            margin-top: 1rem;
            background: var(--card-glass);
            border-radius: 12px;
            padding: 0.6rem;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
        }

        .song-item {
            padding: 0.8rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            backdrop-filter: blur(5px);
        }

        .song-item:hover {
            background: rgba(0, 230, 255, 0.2);
            transform: translateX(6px);
        }

        .song-item.playing {
            background: rgba(0, 230, 255, 0.3);
            border-left: 4px solid var(--accent-cyan);
            box-shadow: var(--glow-intensity);
            transform: translateX(4px);
        }

        .song-title {
            font-weight: 600;
            color: var(--text-light);
        }

        .song-duration {
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        /* éŸ³ä¹æ’­æ”¾å™¨æœ€å°åŒ–/æœ€å¤§åŒ–æŒ‰é’® */
        .window-control-btn {
            background: rgba(255, 255, 255, 0.12);
            border: none;
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 0.6rem;
            backdrop-filter: blur(8px);
        }

        .window-control-btn:hover {
            background: rgba(0, 230, 255, 0.3);
            transform: scale(1.15) rotate(3deg);
            box-shadow: var(--glow-intensity);
        }

        /* æ›´æ˜æ˜¾çš„ç¬”è®°æœ¬æ”¾å¤§åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .notebook-toggle-btn {
            background: var(--accent-cyan);
            color: #000;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,230,255,0.3), var(--glow-intensity);
            margin-left: 0.8rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .notebook-toggle-btn:hover { 
            transform: scale(1.15) rotate(8deg);
            box-shadow: 0 10px 24px rgba(0,230,255,0.4), var(--glow-intensity);
        }

        /* éŸ³ä¹æ’­æ”¾å™¨å›¾æ ‡ - å§‹ç»ˆæ˜¾ç¤ºåœ¨åº•éƒ¨ */
        .music-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 55px;
            height: 55px;
            background: var(--accent-cyan);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 8px 24px rgba(0, 230, 255, 0.5), var(--glow-intensity);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: float 3s ease-in-out infinite;
        }

        .music-icon:hover {
            transform: scale(1.2) rotate(15deg);
            box-shadow: 0 12px 32px rgba(0, 230, 255, 0.6), var(--glow-intensity);
        }

        .music-icon i {
            color: #000;
            font-size: 1.6rem;
        }

        /* è°ƒæ•´å¤§å°æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 16px;
            height: 16px;
            cursor: nwse-resize;
            background: var(--accent-cyan);
            border-radius: 4px;
            z-index: 1001;
            box-shadow: var(--glow-intensity);
        }

        /* å·¦ä¾§é¢æ¿ï¼šå¯¼èˆªåŒº */
                  .left-panel {
              display: flex; flex-direction: column; gap: 2rem;
              overflow-y: auto; padding-right: 10px;
          }
  
        /* æœç´¢æ¡†æ ·å¼ */
        .search-section {
            margin-bottom: 1.5rem;
        }
        
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .tech-search-input {
            width: 100%;
            padding: 16px 60px 16px 24px;
            background: rgba(15, 17, 26, 0.8);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            color: var(--text-main);
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(15px);
            box-shadow: var(--shadow-light);
            font-family: 'Inter', 'Segoe UI', sans-serif;
        }
        
        .tech-search-input:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(0, 230, 255, 0.25), var(--glow-intensity);
            background: rgba(20, 22, 35, 0.9);
        }
        
        .tech-search-input::placeholder {
            color: var(--text-dim);
            opacity: 0.8;
        }
        
        .search-btn {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 230, 255, 0.15);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            font-size: 1.2rem;
            cursor: pointer;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
        }
        
        .search-btn:hover {
            background: var(--accent-cyan);
            color: #000;
            transform: translateY(-50%) scale(1.15);
            box-shadow: var(--glow-intensity);
        }
        
        .search-btn:active {
            transform: translateY(-50%) scale(1.05);
        }
        
        .search-btn i {
            font-size: 1.3rem;
        }
        
        /* æœç´¢æ¡†åŠ¨ç”»æ•ˆæœ */
        @keyframes search-pulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(0, 230, 255, 0.7); 
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(0, 230, 255, 0); 
            }
        }
        
        .tech-search-input:focus + .search-btn {
            animation: search-pulse 2s infinite;
        }
        
        /* æœç´¢å»ºè®®æ¡† */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-glass);
            backdrop-filter: blur(25px);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            margin-top: 10px;
            box-shadow: var(--shadow-medium), var(--glow-subtle);
            z-index: 1000;
            display: none;
            overflow: hidden;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .search-suggestion-item {
            padding: 14px 24px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        
        .search-suggestion-item:hover {
            background: rgba(0, 230, 255, 0.2);
            color: var(--accent-cyan);
            transform: translateX(5px);
        }
        
        .search-suggestion-item .suggestion-text {
            font-size: 1rem;
            font-weight: 500;
        }
        
        .search-suggestion-item .suggestion-hint {
            font-size: 0.85rem;
            color: var(--text-dim);
            opacity: 0.8;
        }
        
        .search-suggestion-item:hover .suggestion-hint {
            color: var(--accent-cyan);
            opacity: 1;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .tech-search-input {
                padding: 14px 55px 14px 20px;
                font-size: 1.05rem;
            }
            
            .search-btn {
                width: 38px;
                height: 38px;
                right: 12px;
            }
        }
        
        @media (max-width: 768px) {
            .search-section {
                margin-bottom: 1rem;
            }
            
            .tech-search-input {
                padding: 12px 50px 12px 18px;
                font-size: 1rem;
                border-radius: 16px;
            }
            
            .search-btn {
                width: 36px;
                height: 36px;
                right: 10px;
                font-size: 1.1rem;
            }
            
            .search-suggestions {
                border-radius: 12px;
            }
            
            .search-suggestion-item {
                padding: 12px 18px;
            }
        }

        .header-section {
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 2rem 2.4rem;
            background: var(--card-glass); 
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border); 
            border-radius: 24px;
            box-shadow: var(--shadow-medium);
        }
        .time-box h1 { 
            font-size: 4.2rem; 
            margin: 0; 
            line-height: 1; 
            font-weight: 800; 
            letter-spacing: -2.5px; 
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 25px rgba(0, 230, 255, 0.4);
        }
        .time-box p { 
            font-size: 1.3rem; 
            color: var(--text-dim); 
            margin: 10px 0 0 0; 
            font-weight: 500;
        }
        .greeting { 
            font-size: 1.4rem; 
            color: var(--accent-cyan); 
            font-weight: 700; 
            text-shadow: 0 0 15px rgba(0, 230, 255, 0.5);
        }

        .section-title {
            font-size: 1rem; 
            color: var(--text-dim); 
            margin-bottom: 1rem;
            display: flex; 
            align-items: center; 
            gap: 0.8rem;
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            font-weight: 800;
        }
        .section-title::after {
            content: ''; 
            flex-grow: 1; 
            height: 2px; 
            background: linear-gradient(to right, var(--accent-cyan), transparent);
        }

        .nav-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 1.4rem; 
            margin-bottom: 1.4rem; 
            min-height: 120px; 
            padding: 10px;
        }

        .nav-item {
            background: var(--card-glass); 
            border: 1px solid var(--card-border);
            border-radius: 20px; 
            padding: 1.6rem;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            position: relative; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            user-select: none;
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-light);
        }
        .nav-item:hover {
            border-color: var(--accent-cyan); 
            transform: translateY(-8px) scale(1.05);
            box-shadow: var(--shadow-medium), var(--glow-intensity);
        }
        .nav-item.dragging { 
            opacity: 0.4; 
            border: 1px dashed var(--accent-cyan); 
            transform: none !important;
        }
        .nav-icon { 
            font-size: 2.4rem; 
            margin-bottom: 0.8rem; 
            text-shadow: 0 0 12px rgba(0, 230, 255, 0.4);
        }
        .nav-item:hover .nav-icon {
            transform: scale(1.2) rotate(5deg);
        }
        .nav-title { 
            font-size: 1rem; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 100%;
            font-weight: 600;
        }

        .add-btn {
            border: 2px dashed var(--card-border); 
            color: var(--text-dim);
            min-height: 120px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 20px; 
            cursor: pointer; 
            flex-direction: column; 
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(25, 27, 38, 0.4);
            font-size: 1.1rem;
            font-weight: 600;
        }
        .add-btn:hover { 
            border-color: var(--accent-cyan); 
            color: var(--accent-cyan); 
            background: rgba(0,230,255,0.12); 
            transform: scale(1.08) translateY(-4px);
            box-shadow: var(--glow-intensity);
        }

        .delete-btn {
            position: absolute; 
            top: 10px; 
            right: 10px; 
            width: 26px; 
            height: 26px;
            background: var(--danger); 
            color: white; 
            border-radius: 50%;
            display: none; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            border: none; 
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .nav-item:hover .delete-btn { 
            display: flex; 
            animation: pulse 1s infinite;
        }

        /* å³ä¾§é¢æ¿ï¼šç¬”è®°æœ¬ç³»ç»Ÿ (å‡çº§æ ¸å¿ƒ) */
        .right-panel { 
            height: 100%; 
        }
        
        .notebook-container {
            background: var(--card-glass); 
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border); 
            border-radius: 24px;
            height: 100%; 
            display: flex; 
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-medium);
        }

        /* ç¬”è®°æœ¬ï¼šå·¦ä¾§åˆ—è¡¨æ  */
        .note-sidebar {
            width: 290px; 
            background: rgba(15, 17, 28, 0.6);
            border-right: 1px solid var(--card-border);
            display: flex; 
            flex-direction: column;
        }
        /* å‚ç›´åˆ†éš”æ ï¼ˆç”¨äºæ‹–åŠ¨æ”¹å˜å·¦ä¾§å®½åº¦ï¼‰ */
        .splitter {
            width: 12px; 
            cursor: col-resize; 
            background: transparent;
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: background 0.2s;
            z-index: 50;
        }
        .splitter:before {
            content: '';
            width: 4px; 
            height: 60px; 
            border-radius: 4px;
            background: linear-gradient(to bottom, var(--accent-cyan), var(--accent-purple));
            transition: all 0.2s;
        }
        .splitter:hover { 
            background: rgba(255,255,255,0.06); 
        }
        .splitter:hover:before { 
            height: 80px; 
            box-shadow: var(--glow-intensity);
        }
        .sidebar-header {
            padding: 1.4rem; 
            border-bottom: 1px solid var(--card-border);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 1.1rem; 
            font-weight: 700; 
            color: var(--text-dim);
        }
        .new-note-btn {
            background: none; 
            border: none; 
            color: var(--accent-cyan);
            font-size: 1.4rem; 
            cursor: pointer; 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .new-note-btn:hover { 
            transform: scale(1.3) rotate(20deg); 
            color: #fff; 
            text-shadow: 0 0 15px rgba(0, 230, 255, 0.6);
        }

        .note-list {
            flex-grow: 0.7; 
            overflow-y: auto; 
            padding: 0.8rem;
        }
        .note-list-item {
            padding: 14px 16px; 
            margin-bottom: 10px; 
            border-radius: 12px;
            cursor: pointer; 
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            backdrop-filter: blur(8px);
        }
        .note-list-item:hover { 
            background: rgba(255,255,255,0.12); 
            transform: translateX(6px);
        }
        .note-list-item.active {
            background: var(--active-item-bg);
            border-left: 5px solid var(--accent-cyan);
            box-shadow: var(--glow-intensity);
            transform: translateX(4px);
        }
        .note-item-title {
            font-size: 1rem; 
            color: var(--text-main);
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            max-width: 140px;
            font-weight: 600;
        }
        .note-item-date { 
            font-size: 0.8rem; 
            color: var(--text-dim); 
        }
        
        .del-note-btn {
            opacity: 0; 
            color: var(--text-dim); 
            font-size: 0.9rem;
            cursor: pointer; 
            margin-left: 8px;
            transition: all 0.25s;
        }
        .note-list-item:hover .del-note-btn { 
            opacity: 1; 
            transform: translateX(4px);
        }
        .del-note-btn:hover { 
            color: var(--danger); 
            transform: scale(1.3) translateX(4px);
        }

        /* ç¬”è®°æœ¬ï¼šå³ä¾§ç¼–è¾‘åŒº */
        .note-editor {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column;
        }
        .editor-header {
            padding: 1.4rem 2rem; 
            border-bottom: 1px solid var(--card-border);
        }
        input.note-title-input {
            background: transparent; 
            border: none;
            font-size: 1.8rem; 
            font-weight: 800; 
            color: var(--text-main);
            width: 100%; 
            outline: none; 
            padding: 8px 0;
            font-family: inherit;
            text-shadow: 0 0 10px rgba(0, 230, 255, 0.25);
        }
        input.note-title-input:focus { 
            border-bottom: 3px solid var(--accent-cyan); 
            box-shadow: 0 4px 12px rgba(0, 230, 255, 0.25);
        }
        
        .note-meta-info {
            font-size: 0.9rem; 
            color: var(--text-dim); 
            margin-top: 10px;
            display: flex; 
            gap: 20px;
            font-weight: 500;
        }

        .note-content-area {
            flex-grow: 1; 
            background: transparent; 
            border: none;
            padding: 2rem; 
            color: var(--text-main);
            font-size: 1.1rem; 
            line-height: 1.9; 
            outline: none;
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            overflow-y: auto;
            caret-color: var(--accent-cyan);
        }
        .note-content-area img { 
            max-width: 100%; 
            cursor: zoom-in; 
            display: block; 
            margin: 16px 0; 
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            transition: transform 0.4s, box-shadow 0.4s;
        }
        .note-content-area img:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 28px rgba(0, 230, 255, 0.25);
        }
        /* æ»šåŠ¨æ¡å‡ºç°åœ¨å†…å®¹åŒº */
        .note-content-area::-webkit-scrollbar { 
            width: 10px; 
        }

        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€ */
        .image-preview-overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.92); 
            display: none;
            justify-content: center; 
            align-items: center; 
            z-index: 1200;
            backdrop-filter: blur(15px);
        }
        .image-preview-overlay img { 
            max-width: 94vw; 
            max-height: 94vh; 
            border-radius: 16px; 
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.7), var(--glow-intensity); 
        }

        /* --- å¼¹çª— --- */
        .modal-overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(12px);
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 100;
        }
        .modal {
            background: #12141c; 
            border: 1px solid var(--card-border);
            padding: 2.4rem; 
            border-radius: 24px; 
            width: 360px;
            box-shadow: var(--shadow-deep), var(--glow-intensity);
            backdrop-filter: blur(16px);
        }
        .modal h3 { 
            margin-top: 0; 
            color: var(--accent-cyan); 
            font-weight: 700;
            text-shadow: 0 0 15px rgba(0, 230, 255, 0.4);
            font-size: 1.4rem;
        }
        .input-group { 
            margin-bottom: 1.4rem; 
        }
        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.95rem;
        }
        .input-group input {
            width: 100%; 
            padding: 14px; 
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--card-border); 
            border-radius: 10px; 
            color: white;
            font-size: 1.05rem;
            transition: all 0.3s;
            font-family: inherit;
        }
        .input-group input:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 4px rgba(0, 230, 255, 0.25);
            background: rgba(255,255,255,0.15);
        }
        .modal-btns { 
            display: flex; 
            justify-content: flex-end; 
            gap: 16px; 
        }
        .btn { 
            padding: 12px 28px; 
            border-radius: 10px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1rem;
        }
        .btn-confirm { 
            background: var(--accent-cyan); 
            color: #000; 
            box-shadow: var(--glow-intensity);
        }
        .btn-cancel { 
            background: #2a2d3a; 
            color: #fff;
            border: 1px solid var(--card-border);
        }
        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        /* æƒé™æç¤º */
        .permission-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 77, 90, 0.95);
            color: white;
            padding: 14px 22px;
            border-radius: 12px;
            font-size: 1rem;
            z-index: 1000;
            display: none;
            box-shadow: 0 6px 20px rgba(255, 77, 90, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-weight: 600;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(8deg); }
        }

        @media (max-width: 900px) {
            .container { 
                grid-template-columns: 1fr; 
                height: auto; 
                display: block; 
            }
            .left-panel { 
                margin-bottom: 2.8rem; 
            }
            .notebook-container { 
                height: 620px; 
            }
            .music-player {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
                bottom: 110px;
                border-radius: 16px;
            }
            .music-icon {
                bottom: 25px;
                right: 25px;
                width: 50px;
                height: 50px;
            }
            .header-section {
                padding: 1.8rem;
            }
            .time-box h1 {
                font-size: 3.2rem;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="left-panel">
        <!-- é¡¶éƒ¨æœç´¢æ  -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" 
                       class="tech-search-input" 
                       id="googleSearchInput" 
                       placeholder="è¾“å…¥æœç´¢å†…å®¹ï¼ŒæŒ‰Enteræˆ–ç‚¹å‡»æœç´¢..." 
                       autocomplete="off">
                <button class="search-btn" id="searchBtn" title="æœç´¢">
                    <i>ğŸ”</i>
                </button>
                <div class="search-suggestions" id="searchSuggestions">
                </div>
            </div>
        </div>

        <div class="header-section">
            <div class="time-box">
                <h1 id="clock">00:00</h1>
                <p id="date">Loading...</p>
            </div>
            <div style="display:flex; align-items:flex-end; gap:8px;">
                <div class="greeting" id="greetingText">System Online</div>
                <button id="toggleNotebookBtn" class="window-control-btn notebook-toggle-btn" onclick="toggleNotebookSize()" title="æ”¾å¤§/è¿˜åŸç¬”è®°æœ¬" aria-label="æ”¾å¤§ç¬”è®°æœ¬">ğŸ”</button>
            </div>
        </div>

        <div>
            <div class="section-title">ğŸŒ å¸¸ç”¨ç½‘ç«™</div>
            <div class="nav-grid sortable-grid" id="webGrid"></div>
            <div class="add-btn" onclick="openModal('websites')"><span>â• æ·»åŠ ç½‘ç«™</span></div>
        </div>

        <div>
            <div class="section-title">ğŸ’» åº”ç”¨ç¨‹åº</div>
            <div class="nav-grid sortable-grid" id="appGrid"></div>
            <div class="add-btn" onclick="openModal('software')"><span>â• æ·»åŠ è½¯ä»¶</span></div>
        </div>
    </div>

    <!-- å³ä¾§é¢æ¿ï¼šç¬”è®°æœ¬ -->
    <div class="right-panel">
        <div class="notebook-container">
            <!-- ç¬”è®°åˆ—è¡¨ -->
            <div class="note-sidebar">
                <div class="sidebar-header">
                    <span>æˆ‘çš„ç¬”è®°æœ¬</span>
                    <button class="new-note-btn" onclick="createNewNote()" title="æ–°å»ºç¬”è®°">â•</button>
                </div>
                <div style="padding:0.4rem; border-bottom:1px solid var(--card-border); display:flex; justify-content:space-between; align-items:center; gap:8px;">
                    <div id="categoryList" style="display:flex; gap:8px; overflow:auto;"></div>
                    <button class="new-note-btn" onclick="createNewCategory()" title="æ–°å»ºåˆ†ç±»">ğŸ“â•</button>
                </div>
                <div class="note-list" id="noteList">
                    <!-- JS ç”Ÿæˆåˆ—è¡¨é¡¹ -->
                </div>
            </div>

            <!-- ç¬”è®°ç¼–è¾‘åŒº -->
            <div id="notebookSplitter" class="splitter" title="æ‹–åŠ¨è°ƒæ•´ç¬”è®°åˆ—è¡¨å®½åº¦"></div>
            <div class="note-editor">
                <div class="editor-header">
                    <input type="text" id="noteTitleInput" class="note-title-input" placeholder="æ— æ ‡é¢˜ç¬”è®°">
                    <div class="note-meta-info">
                        <span id="noteUpdateTime">æ›´æ–°äº: --</span>
                        <span id="noteCharCount">0 å­—</span>
                    </div>
                </div>
                <div id="noteContentInput" class="note-content-area" contenteditable="true" placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..."></div>
                <div class="image-preview-overlay" id="imagePreview" onclick="hideImagePreview()">
                    <img id="imagePreviewImg" src="" alt="preview">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- éŸ³ä¹æ’­æ”¾å™¨ -->
<div class="music-player" id="musicPlayer" style="display: none;">
    <div class="music-player-header">
        <div class="current-playlist" id="currentPlaylist">æœªé€‰æ‹©æ’­æ”¾åˆ—è¡¨</div>
        <div style="display: flex; align-items: center;">
            <div class="playback-mode">
                <button class="playback-mode-btn active" data-mode="list" onclick="setPlaybackMode('list')">åˆ—è¡¨</button>
                <button class="playback-mode-btn" data-mode="repeat" onclick="setPlaybackMode('repeat')">å•æ›²</button>
                <button class="playback-mode-btn" data-mode="shuffle" onclick="setPlaybackMode('shuffle')">éšæœº</button>
            </div>
            <button class="window-control-btn" onclick="toggleMinimizePlayer()" title="æœ€å°åŒ–/è¿˜åŸ">âˆ’</button>
            <button class="window-control-btn" onclick="hideMusicPlayer()" title="éšè—">Ã—</button>
        </div>
    </div>
    
    <div class="playlist-selector" id="playlistSelector">
        <!-- æ’­æ”¾åˆ—è¡¨æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <div class="songs-list" id="songsList">
        <!-- æ­Œæ›²åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <div class="player-controls">
        <div class="current-song-info">
            <div class="current-song-title" id="currentSongTitle">è¯·é€‰æ‹©æ­Œæ›²</div>
            <div class="current-song-artist" id="currentSongArtist">æœªçŸ¥è‰ºæœ¯å®¶</div>
        </div>
        
        <div class="progress-container">
            <span id="currentTime">00:00</span>
            <div class="progress-bar" onclick="seekSong(event)">
                <div class="progress" id="progressBar"></div>
            </div>
            <span id="totalTime">00:00</span>
        </div>
        
        <button class="player-btn" onclick="prevSong()" title="ä¸Šä¸€é¦–">â®</button>
        <button class="player-btn play-pause" id="playPauseBtn" onclick="togglePlayPause()" title="æ’­æ”¾/æš‚åœ">â–¶</button>
        <button class="player-btn" onclick="nextSong()" title="ä¸‹ä¸€é¦–">â­</button>
    </div>
    
    <div class="resize-handle" id="resizeHandle"></div>
</div>

<!-- éŸ³ä¹æ’­æ”¾å™¨å›¾æ ‡ - å§‹ç»ˆæ˜¾ç¤ºåœ¨åº•éƒ¨ -->
<div class="music-icon" id="musicIcon" onclick="showMusicPlayer()" style="display: none;">
    <i>ğŸµ</i>
</div>

<!-- æƒé™è­¦å‘Šæç¤º -->
<div class="permission-warning" id="permissionWarning">æ‚¨æ²¡æœ‰ç¼–è¾‘æƒé™ï¼Œä»…å¯æŸ¥çœ‹å†…å®¹</div>

<!-- æ·»åŠ å¯¼èˆªçš„å¼¹çª— -->
<div class="modal-overlay" id="addModal">
    <div class="modal">
        <h3 id="modalTitle">æ·»åŠ æ–°é¡¹</h3>
        <input type="hidden" id="addType">
        <div class="input-group">
            <label>åç§°</label><input type="text" id="linkTitle">
        </div>
        <div class="input-group">
            <label>é“¾æ¥/è·¯å¾„</label><input type="text" id="linkUrl" placeholder="https:// æˆ– D:\xxx.exe">
        </div>
        <div class="input-group">
            <label>å›¾æ ‡</label><input type="text" id="linkIcon" placeholder="â¤ï¸">
        </div>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-confirm" onclick="confirmAdd()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
    // --- éŸ³ä¹æ’­æ”¾å™¨ç›¸å…³å˜é‡ ---
    let audioPlayer = new Audio();
    let currentPlaylist = [];
    let currentSongIndex = -1;
    let playbackMode = 'list'; // 'list', 'repeat', 'shuffle'
    let playlists = [];
    let shuffledOrder = [];
    let shuffleIndex = 0;
    let isPlayerVisible = false;
    let isPlayerMinimized = false;
    let isResizing = false;
    let originalWidth = 400;
    let originalHeight = 400;
    
    // --- æ•°æ®ç»“æ„ ---
    let globalData = {
        websites: [],
        software: [],
        notes: [], // å…¼å®¹æ—§ç»“æ„ï¼Œä»ä¿ç•™å¹³é“º notes
        note_categories: [] // æ–°å¢ï¼šåˆ†ç±»ç»“æ„ [{id, name, notes: [...]}]
    };
    let currentCategoryId = null; // å½“å‰é€‰ä¸­çš„åˆ†ç±»ï¼ˆnull è¡¨ç¤ºæœªé€‰æ‹©ï¼Œä½¿ç”¨å¹³é“º notesï¼‰
    
    let currentNoteId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘å“ªä¸ªç¬”è®°
    let userRole = 'user'; // é»˜è®¤ä¸ºæ™®é€šç”¨æˆ·

    // --- 1. åŸºç¡€åŠŸèƒ½ (æ—¶é—´) ---
    function updateTime() {
        const now = new Date();
        document.getElementById('clock').innerText = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        document.getElementById('date').innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
        const h = now.getHours();
        document.getElementById('greetingText').innerText = `Allencaiï¼Œ${h<11?"ä¸Šåˆå¥½":h<13?"ä¸­åˆå¥½":h<18?"ä¸‹åˆå¥½":"æ™šä¸Šå¥½"}`;
    }
    setInterval(updateTime, 1000); updateTime();

    // --- 2. æ•°æ®åŠ è½½ä¸è¿ç§» ---
    async function loadData() {
        try {
            const res = await fetch('/api/get_data');
            const serverData = await res.json();

            // æ•°æ®è¿ç§»ï¼šå¦‚æœåªæœ‰æ—§ç‰ˆ memo (å­—ç¬¦ä¸²)ï¼Œè½¬æ¢æˆæ–°ç‰ˆ notes (æ•°ç»„)
            if (serverData.memo && (!serverData.notes || serverData.notes.length === 0)) {
                globalData.notes = [{
                    id: Date.now(),
                    title: 'é»˜è®¤ç¬”è®°',
                    content: serverData.memo,
                    updated: new Date().toLocaleString()
                }];
                // è¿ç§»å…¶ä»–æ•°æ®
                globalData.websites = serverData.websites || serverData.links || [];
                globalData.software = serverData.software || [];
            } else {
                globalData = serverData;
                // ç¡®ä¿å„é¡¹éƒ½ä¸ä¸ºç©º
                if(!globalData.notes) globalData.notes = [];
                if(!globalData.websites) globalData.websites = [];
                if(!globalData.software) globalData.software = [];
            }

            // åˆå§‹åŒ–ç•Œé¢
            renderAllNav();

            // æ•°æ®è¿ç§»ï¼šå¦‚æœå­˜åœ¨æ—§ç‰ˆå¹³é“º notesï¼Œä½†æ²¡æœ‰åˆ†ç±»ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªé»˜è®¤åˆ†ç±»å¹¶è¿ç§»
            if ((!globalData.note_categories || globalData.note_categories.length === 0) && globalData.notes && globalData.notes.length > 0) {
                const defaultCat = {
                    id: Date.now(),
                    name: 'é»˜è®¤',
                    notes: globalData.notes.slice()
                };
                globalData.note_categories = [defaultCat];
                currentCategoryId = defaultCat.id;
            }

            // ç¡®ä¿ç»“æ„å­˜åœ¨
            if(!globalData.note_categories) globalData.note_categories = [];
            if(!globalData.notes) globalData.notes = [];

            renderCategoryList();
            // å¦‚æœæœ‰åˆ†ç±»åˆ™é€‰ä¸­ç¬¬ä¸€ä¸ªåˆ†ç±»å¹¶æ¸²æŸ“å…¶ç¬”è®°
            if (globalData.note_categories.length > 0) {
                if (!currentCategoryId) currentCategoryId = globalData.note_categories[0].id;
                renderNoteList();
                const firstCat = globalData.note_categories.find(c => c.id === currentCategoryId);
                if (firstCat && firstCat.notes && firstCat.notes.length>0) {
                    switchNote(firstCat.notes[0].id);
                } else {
                    createNewNote(false);
                }
            } else {
                // å…¼å®¹ï¼šæ²¡æœ‰åˆ†ç±»æ—¶æŒ‰å¹³é“º notes å¤„ç†
                if (globalData.notes.length === 0) {
                    createNewNote(false);
                } else {
                    switchNote(globalData.notes[0].id);
                }
                renderNoteList();
            }

            // æ£€æŸ¥ç”¨æˆ·æƒé™å¹¶è®¾ç½®ç•Œé¢
            checkUserPermissions();

        } catch(e) { console.error("åŠ è½½å¤±è´¥", e); }
    }

    // --- éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ– ---
    async function initMusicPlayer() {
        try {
            const response = await fetch('/api/get_music_playlists');
            playlists = await response.json();
            
            // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨é€‰æ‹©å™¨
            renderPlaylistSelector();
            
            // å§‹ç»ˆæ˜¾ç¤ºéŸ³ä¹å›¾æ ‡
            document.getElementById('musicIcon').style.display = 'flex';
            
            if (playlists.length > 0) {
                // é»˜è®¤ä¸è‡ªåŠ¨æ˜¾ç¤ºæ’­æ”¾å™¨ï¼Œåªæ˜¾ç¤ºå›¾æ ‡
                console.log("éŸ³ä¹æ’­æ”¾å™¨å·²åˆå§‹åŒ–ï¼Œç‚¹å‡»å³ä¸‹è§’ğŸµå›¾æ ‡æ‰“å¼€");
            } else {
                console.log("æ²¡æœ‰æ‰¾åˆ°éŸ³ä¹æ’­æ”¾åˆ—è¡¨");
            }
        } catch (error) {
            console.error("åŠ è½½éŸ³ä¹æ’­æ”¾åˆ—è¡¨å¤±è´¥:", error);
        }
    }
    
    // --- æ£€æŸ¥ç”¨æˆ·æƒé™ ---
    async function checkUserPermissions() {
        try {
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const response = await fetch('/api/get_user_info');
            if (response.ok) {
                const userInfo = await response.json();
                userRole = userInfo.role || 'user';
                
                // æ ¹æ®è§’è‰²è®¾ç½®ç•Œé¢æƒé™
                setInterfacePermissions();
            } else {
                // å¦‚æœæ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå‡è®¾ä¸ºæ™®é€šç”¨æˆ·
                userRole = 'user';
                setInterfacePermissions();
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            userRole = 'user';
            setInterfacePermissions();
        }
    }

    // --- è®¾ç½®ç•Œé¢æƒé™ ---
    function setInterfacePermissions() {
        if (userRole === 'admin') {
            // ç®¡ç†å‘˜æ‹¥æœ‰å…¨éƒ¨æƒé™
            enableAllFeatures();
            document.getElementById('permissionWarning').style.display = 'none';
        } else {
            // æ™®é€šç”¨æˆ·åªæœ‰æŸ¥çœ‹æƒé™
            disableEditingFeatures();
            document.getElementById('permissionWarning').style.display = 'block';
        }
    }

    // --- å¯ç”¨æ‰€æœ‰åŠŸèƒ½ï¼ˆç®¡ç†å‘˜ï¼‰---
    function enableAllFeatures() {
        // å¯ç”¨æ·»åŠ æŒ‰é’®
        document.querySelectorAll('.add-btn').forEach(btn => {
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        });
        
        // å¯ç”¨ç¼–è¾‘åŒºåŸŸ
        document.getElementById('noteTitleInput').readOnly = false;
        const contentEl = document.getElementById('noteContentInput');
        if (contentEl) contentEl.contentEditable = 'true';
        document.querySelector('.new-note-btn').style.pointerEvents = 'auto';
        
        // å¯ç”¨åˆ é™¤æŒ‰é’®ï¼ˆé€šè¿‡CSSæ§åˆ¶ï¼‰
        const style = document.createElement('style');
        style.innerHTML = `
            .nav-item:hover .delete-btn { display: flex !important; }
            .note-list-item:hover .del-note-btn { opacity: 1 !important; }
        `;
        document.head.appendChild(style);
        // é‡æ–°æ¸²æŸ“å¯¼èˆªä»¥å¯ç”¨åˆ é™¤æŒ‰é’®å’Œå¯æ‹–æ‹½å±æ€§
        renderAllNav();
    }

    // --- ç¦ç”¨ç¼–è¾‘åŠŸèƒ½ï¼ˆæ™®é€šç”¨æˆ·ï¼‰---
    function disableEditingFeatures() {
        // ç¦ç”¨æ·»åŠ æŒ‰é’®
        document.querySelectorAll('.add-btn').forEach(btn => {
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';
        });
        
        // ç¦ç”¨ç¼–è¾‘åŒºåŸŸ
        document.getElementById('noteTitleInput').readOnly = true;
        const contentEl = document.getElementById('noteContentInput');
        if (contentEl) contentEl.contentEditable = 'false';
        document.querySelector('.new-note-btn').style.pointerEvents = 'none';
        
        // éšè—åˆ é™¤æŒ‰é’®
        const style = document.createElement('style');
        style.innerHTML = `
            .delete-btn, .del-note-btn {
                display: none !important;
            }
            .add-btn {
                cursor: not-allowed !important;
            }
            .note-title-input, .note-content-area {
                background: rgba(255,255,255,0.02) !important;
                cursor: not-allowed !important;
            }
        `;
        document.head.appendChild(style);
        // é‡æ–°æ¸²æŸ“å¯¼èˆªä»¥ç¦ç”¨åˆ é™¤å’Œæ‹–æ‹½
        renderAllNav();
    }

    function renderPlaylistSelector() {
        const container = document.getElementById('playlistSelector');
        container.innerHTML = '';
        
        playlists.forEach(playlist => {
            const button = document.createElement('button');
            button.className = 'playlist-btn';
            button.textContent = playlist.name;
            button.onclick = () => loadPlaylist(playlist.name);
            container.appendChild(button);
        });
    }

    function loadPlaylist(playlistName) {
        const playlist = playlists.find(p => p.name === playlistName);
        if (!playlist) return;
        
        currentPlaylist = playlist.songs;
        document.getElementById('currentPlaylist').textContent = playlistName;
        currentSongIndex = -1;
        renderSongsList();
        
        // æ›´æ–°æŒ‰é’®æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.playlist-btn').forEach(btn => {
            btn.classList.toggle('active', btn.textContent === playlistName);
        });
    }

    function renderSongsList() {
        const container = document.getElementById('songsList');
        container.innerHTML = '';
        
        currentPlaylist.forEach((song, index) => {
            const songElement = document.createElement('div');
            songElement.className = `song-item ${index === currentSongIndex ? 'playing' : ''}`;
            songElement.onclick = () => playSong(index);
            songElement.innerHTML = `
                <div class="song-title">${song.title}</div>
                <div class="song-duration">--:--</div>
            `;
            container.appendChild(songElement);
        });
    }

    function playSong(index) {
        if (index < 0 || index >= currentPlaylist.length) return;
        
        currentSongIndex = index;
        const song = currentPlaylist[index];
        // ä½¿ç”¨æ–°çš„ç›¸å¯¹è·¯å¾„æ ¼å¼
        const songUrl = `/music/${encodeURIComponent(song.relative_path)}`;
        
        // è®¾ç½®éŸ³é¢‘æºå¹¶æ’­æ”¾
        audioPlayer.src = songUrl;
        audioPlayer.load(); // ç¡®ä¿é‡æ–°åŠ è½½éŸ³é¢‘
        audioPlayer.play().then(() => {
            document.getElementById('playPauseBtn').innerHTML = 'â¸'; // æš‚åœå›¾æ ‡
        }).catch(e => console.error("æ’­æ”¾å¤±è´¥:", e));
        
        // æ›´æ–°UI
        updatePlayerUI();
        renderSongsList();
    }

    function togglePlayPause() {
        if (audioPlayer.paused) {
            audioPlayer.play().then(() => {
                document.getElementById('playPauseBtn').innerHTML = 'â¸'; // æš‚åœå›¾æ ‡
            }).catch(e => console.error("æ’­æ”¾å¤±è´¥:", e));
        } else {
            audioPlayer.pause();
            document.getElementById('playPauseBtn').innerHTML = 'â–¶'; // æ’­æ”¾å›¾æ ‡
        }
    }

    function nextSong() {
        if (currentPlaylist.length === 0) return;
        
        if (playbackMode === 'repeat') {
            // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
            playSong(currentSongIndex);
        } else if (playbackMode === 'shuffle') {
            // éšæœºæ’­æ”¾æ¨¡å¼
            if (shuffledOrder.length === 0) {
                generateShuffledOrder();
            }
            shuffleIndex = (shuffleIndex + 1) % shuffledOrder.length;
            playSong(shuffledOrder[shuffleIndex]);
        } else {
            // åˆ—è¡¨é¡ºåºæ’­æ”¾
            const nextIndex = (currentSongIndex + 1) % currentPlaylist.length;
            playSong(nextIndex);
        }
    }

    function prevSong() {
        if (currentPlaylist.length === 0) return;
        
        if (playbackMode === 'repeat') {
            // å•æ›²å¾ªç¯ï¼Œé‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
            playSong(currentSongIndex);
        } else if (playbackMode === 'shuffle') {
            // éšæœºæ’­æ”¾æ¨¡å¼
            if (shuffledOrder.length === 0) {
                generateShuffledOrder();
            }
            shuffleIndex = shuffleIndex === 0 ? shuffledOrder.length - 1 : shuffleIndex - 1;
            playSong(shuffledOrder[shuffleIndex]);
        } else {
            // åˆ—è¡¨é¡ºåºæ’­æ”¾
            const prevIndex = currentSongIndex === 0 ? currentPlaylist.length - 1 : currentSongIndex - 1;
            playSong(prevIndex);
        }
    }

    function generateShuffledOrder() {
        // ç”Ÿæˆéšæœºæ’­æ”¾é¡ºåº
        shuffledOrder = Array.from(Array(currentPlaylist.length).keys());
        for (let i = shuffledOrder.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledOrder[i], shuffledOrder[j]] = [shuffledOrder[j], shuffledOrder[i]];
        }
        shuffleIndex = 0;
    }

    function setPlaybackMode(mode) {
        playbackMode = mode;
        document.querySelectorAll('.playback-mode-btn').forEach(btn => {
            if(btn.dataset.mode) {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            }
        });
    }

    function toggleMinimizePlayer() {
        const player = document.getElementById('musicPlayer');
        isPlayerMinimized = !isPlayerMinimized;
        
        if (isPlayerMinimized) {
            player.classList.add('minimized');
            document.querySelector('.window-control-btn').innerHTML = '+'; // å±•å¼€å›¾æ ‡
        } else {
            player.classList.remove('minimized');
            document.querySelector('.window-control-btn').innerHTML = 'âˆ’'; // æœ€å°åŒ–å›¾æ ‡
        }
    }

    function showMusicPlayer() {
        document.getElementById('musicPlayer').style.display = 'flex';
        isPlayerVisible = true;
        
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ˜¾ç¤ºï¼ŒåŠ è½½æ’­æ”¾åˆ—è¡¨
        if (playlists.length === 0) {
            initMusicPlayer();
        }
        
        // å¦‚æœæœ‰æ’­æ”¾åˆ—è¡¨ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ª
        if (playlists.length > 0 && currentPlaylist.length === 0) {
            loadPlaylist(playlists[0].name);
        }
    }

    function hideMusicPlayer() {
        document.getElementById('musicPlayer').style.display = 'none';
        isPlayerVisible = false;
    }

    function seekSong(event) {
        const progressBar = document.querySelector('.progress-bar');
        const rect = progressBar.getBoundingClientRect();
        const pos = (event.clientX - rect.left) / rect.width;
        audioPlayer.currentTime = pos * audioPlayer.duration;
    }

    function updatePlayerUI() {
        if (currentSongIndex >= 0 && currentSongIndex < currentPlaylist.length) {
            const song = currentPlaylist[currentSongIndex];
            document.getElementById('currentSongTitle').textContent = song.title;
            document.getElementById('currentSongArtist').textContent = document.getElementById('currentPlaylist').textContent;
        }
    }

    // éŸ³é¢‘äº‹ä»¶ç›‘å¬
    audioPlayer.addEventListener('loadedmetadata', function() {
        document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
    });

    audioPlayer.addEventListener('timeupdate', function() {
        document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
        const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        document.getElementById('progressBar').style.width = progressPercent + '%';
    });

    audioPlayer.addEventListener('ended', function() {
        nextSong();
    });

    audioPlayer.addEventListener('play', function() {
        document.getElementById('playPauseBtn').innerHTML = 'â¸';
    });

    audioPlayer.addEventListener('pause', function() {
        document.getElementById('playPauseBtn').innerHTML = 'â–¶';
    });

    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    // è°ƒæ•´å¤§å°åŠŸèƒ½
    function initResize() {
        const resizeHandle = document.getElementById('resizeHandle');
        const player = document.getElementById('musicPlayer');
        
        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            e.preventDefault();
            originalWidth = player.offsetWidth;
            originalHeight = player.offsetHeight;
            document.addEventListener('mousemove', resizePlayer);
            document.addEventListener('mouseup', stopResize);
        });
    }

    function resizePlayer(e) {
        if (!isResizing) return;
        
        const player = document.getElementById('musicPlayer');
        const deltaX = e.movementX;
        const deltaY = e.movementY;
        
        let newWidth = originalWidth - deltaX;
        let newHeight = originalHeight - deltaY;
        
        // é™åˆ¶æœ€å°å°ºå¯¸
        newWidth = Math.max(300, newWidth);
        newHeight = Math.max(200, newHeight);
        
        player.style.width = newWidth + 'px';
        player.style.height = newHeight + 'px';
    }

    function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', resizePlayer);
        document.removeEventListener('mouseup', stopResize);
    }

    // --- 3. ç¬”è®°æœ¬é€»è¾‘ (æ ¸å¿ƒå‡çº§) ---

    // æ¸²æŸ“å·¦ä¾§ç¬”è®°åˆ—è¡¨
    function renderNoteList() {
        const listEl = document.getElementById('noteList');
        listEl.innerHTML = '';

        // æ ¹æ®å½“å‰åˆ†ç±»é€‰æ‹©è¦å±•ç¤ºçš„ç¬”è®°é›†åˆ
        let notesToShow = [];
        if (currentCategoryId) {
            const cat = globalData.note_categories.find(c => c.id === currentCategoryId);
            if (cat && cat.notes) notesToShow = cat.notes.slice();
        } else {
            notesToShow = globalData.notes.slice();
        }

        // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€è¿‘ä¿®æ”¹çš„åœ¨ä¸Šé¢ï¼‰
        const sortedNotes = notesToShow.sort((a, b) => new Date(b.updated) - new Date(a.updated));

        sortedNotes.forEach(note => {
            const item = document.createElement('div');
            item.className = `note-list-item ${note.id === currentNoteId ? 'active' : ''}`;
            item.onclick = () => switchNote(note.id);

            // ç®€å•çš„æ—¥æœŸæ ¼å¼åŒ–
            const dateStr = note.updated ? note.updated.split(' ')[0] : 'åˆšåˆš';

            item.innerHTML = `
                <div style="overflow:hidden;">
                    <div class="note-item-title">${note.title || 'æ— æ ‡é¢˜'}</div>
                    <div class="note-item-date">${dateStr}</div>
                </div>
            `;

            // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½çœ‹åˆ°åˆ é™¤æŒ‰é’®
            if (userRole === 'admin') {
                const delBtn = document.createElement('div');
                delBtn.className = 'del-note-btn';
                delBtn.textContent = 'ğŸ—‘ï¸';
                delBtn.onclick = (e) => deleteNote(e, note.id);
                item.appendChild(delBtn);
            }

            listEl.appendChild(item);
        });
    }

    // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨ï¼ˆæ°´å¹³ï¼‰
    function renderCategoryList() {
        const el = document.getElementById('categoryList');
        if(!el) return;
        el.innerHTML = '';

        globalData.note_categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = 'playlist-btn';
            btn.textContent = cat.name;
            btn.style.whiteSpace = 'nowrap';
            btn.onclick = () => switchCategory(cat.id);
            if (cat.id === currentCategoryId) btn.classList.add('active');

            // ç®¡ç†å‘˜å¯åˆ é™¤åˆ†ç±»
            if (userRole === 'admin') {
                const del = document.createElement('span');
                del.style.marginLeft = '6px';
                del.style.cursor = 'pointer';
                del.textContent = 'âœ•';
                del.onclick = (e) => { e.stopPropagation(); deleteCategory(cat.id); };
                btn.appendChild(del);
            }

            el.appendChild(btn);
        });
    }

    function createNewCategory() {
        if (userRole !== 'admin') { showPermissionWarning(); return; }
        const name = prompt('è¯·è¾“å…¥åˆ†ç±»åç§°ï¼š', 'æ–°åˆ†ç±»');
        if (!name) return;
        const cat = { id: Date.now(), name, notes: [] };
        globalData.note_categories.push(cat);
        currentCategoryId = cat.id;
        saveData(); renderCategoryList(); renderNoteList();
    }

    function deleteCategory(id) {
        if (userRole !== 'admin') { showPermissionWarning(); return; }
        if (!confirm('åˆ é™¤è¯¥åˆ†ç±»å°†åŒæ—¶åˆ é™¤å…¶ä¸­çš„æ‰€æœ‰ç¬”è®°ï¼Œç¡®è®¤å—ï¼Ÿ')) return;
        globalData.note_categories = globalData.note_categories.filter(c => c.id !== id);
        if (currentCategoryId === id) currentCategoryId = globalData.note_categories.length ? globalData.note_categories[0].id : null;
        saveData(); renderCategoryList(); renderNoteList();
    }

    function switchCategory(id) {
        currentCategoryId = id;
        renderCategoryList();
        renderNoteList();
        // å¦‚æœåˆ†ç±»å†…æœ‰ç¬”è®°åˆ™åˆ‡æ¢åˆ°ç¬¬ä¸€æ¡
        const cat = globalData.note_categories.find(c => c.id === id);
        if (cat && cat.notes && cat.notes.length>0) switchNote(cat.notes[0].id);
        else createNewNote(false);
    }

    // åˆ‡æ¢å½“å‰ç¬”è®°
    function switchNote(id) {
        currentNoteId = id;
        // åœ¨æ‰€æœ‰åˆ†ç±»ä¸­æŸ¥æ‰¾ç¬”è®°ï¼ˆä¼˜å…ˆåˆ†ç±»ï¼‰ï¼Œè‹¥æœªæ‰¾åˆ°åˆ™æŸ¥æ‰¾å¹³é“º notes
        let note = null;
        for (const cat of (globalData.note_categories || [])) {
            const found = (cat.notes || []).find(n => n.id === id);
            if (found) { note = found; break; }
        }
        if (!note) note = (globalData.notes || []).find(n => n.id === id);

        if (note) {
            document.getElementById('noteTitleInput').value = note.title;
            document.getElementById('noteContentInput').innerHTML = note.content || '';
            document.getElementById('noteUpdateTime').innerText = `æ›´æ–°äº: ${note.updated}`;
            updateCharCount(note.content);
            renderNoteList(); // åˆ·æ–°é€‰ä¸­çŠ¶æ€
        }
    }

    // æ–°å»ºç¬”è®°
    function createNewNote(autoSave = true) {
        if (userRole !== 'admin') {
            showPermissionWarning();
            return;
        }
        
        const newNote = {
            id: Date.now(),
            title: 'æ–°ç¬”è®°',
            content: '',
            updated: new Date().toLocaleString()
        };
        // å¦‚æœé€‰æ‹©äº†åˆ†ç±»ï¼Œåˆ™æ·»åŠ åˆ°å½“å‰åˆ†ç±»ï¼›å¦åˆ™æ·»åŠ åˆ°å¹³é“º notes
        if (currentCategoryId) {
            const cat = globalData.note_categories.find(c => c.id === currentCategoryId);
            if (!cat) {
                // è‹¥åˆ†ç±»ä¸å­˜åœ¨åˆ™æ–°å»º
                const newCat = { id: Date.now()+1, name: 'é»˜è®¤', notes: [newNote] };
                globalData.note_categories.push(newCat);
                currentCategoryId = newCat.id;
            } else {
                cat.notes.unshift(newNote);
            }
        } else {
            globalData.notes.unshift(newNote);
        }
        if (autoSave) saveData();

        switchNote(newNote.id);
        renderCategoryList(); renderNoteList();
        // è‡ªåŠ¨èšç„¦æ ‡é¢˜
        document.getElementById('noteTitleInput').focus();
    }

    // åˆ é™¤ç¬”è®°
    function deleteNote(e, id) {
        if (userRole !== 'admin') {
            showPermissionWarning();
            return;
        }
        
        e.stopPropagation(); // é˜»æ­¢è§¦å‘åˆ‡æ¢
        if (confirm('ç¡®å®šåˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) {
            // ä»åˆ†ç±»ä¸­åˆ é™¤ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä»å¹³é“º notes åˆ é™¤
            let removed = false;
            for (const cat of (globalData.note_categories || [])) {
                const before = cat.notes.length;
                cat.notes = (cat.notes || []).filter(n => n.id !== id);
                if (cat.notes.length !== before) removed = true;
            }
            if (!removed) {
                globalData.notes = (globalData.notes || []).filter(n => n.id !== id);
            }

            // æ‰¾åˆ°å½“å‰æ‰€åœ¨åˆ†ç±»çš„ç¬”è®°é›†åˆï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç©º
            let currentList = null;
            if (currentCategoryId) {
                const cat = globalData.note_categories.find(c => c.id === currentCategoryId);
                if (cat) currentList = cat.notes;
            } else {
                currentList = globalData.notes;
            }

            // å¦‚æœåˆ å…‰äº†ï¼Œè‡ªåŠ¨è¡¥ä¸€ä¸ªï¼ˆåœ¨å½“å‰åˆ†ç±»æˆ–å¹³é“ºï¼‰
            if (!currentList || currentList.length === 0) {
                createNewNote();
            } else {
                // å¦‚æœåˆ çš„æ˜¯å½“å‰æ­£åœ¨çœ‹çš„ï¼Œå°±åˆ‡æ¢åˆ°ç¬¬ä¸€æ¡
                if (id === currentNoteId) {
                    switchNote(currentList[0].id);
                }
                saveData();
                renderNoteList();
            }
        }
    }

    // æ˜¾ç¤ºæƒé™è­¦å‘Š
    function showPermissionWarning() {
        const warning = document.getElementById('permissionWarning');
        warning.style.display = 'block';
        setTimeout(() => {
            warning.style.display = 'none';
        }, 3000);
    }

    // ç›‘å¬è¾“å…¥ï¼Œè‡ªåŠ¨ä¿å­˜
    const titleInput = document.getElementById('noteTitleInput');
    const contentInput = document.getElementById('noteContentInput');

    function handleNoteInput() {
        if (userRole !== 'admin') {
            return; // æ™®é€šç”¨æˆ·ä¸èƒ½ç¼–è¾‘
        }

        // åœ¨åˆ†ç±»ä¸å¹³é“º notes ä¸­æŸ¥æ‰¾å½“å‰ç¬”è®°
        let note = null;
        for (const cat of (globalData.note_categories || [])) {
            const found = (cat.notes || []).find(n => n.id === currentNoteId);
            if (found) { note = found; break; }
        }
        if (!note) note = (globalData.notes || []).find(n => n.id === currentNoteId);

        if (note) {
            note.title = titleInput.value;
            note.content = contentInput.innerHTML;
            note.updated = new Date().toLocaleString();

            // æ›´æ–°ç•Œé¢ä¸Šçš„æ—¶é—´å’Œå­—æ•°
            document.getElementById('noteUpdateTime').innerText = `æ›´æ–°äº: åˆšåˆš`;
            updateCharCount(note.content);

            // é˜²æŠ–ä¿å­˜åˆ°ç¡¬ç›˜
            clearTimeout(window.saveTimer);
            window.saveTimer = setTimeout(() => {
                saveData();
                renderNoteList(); // åˆ·æ–°åˆ—è¡¨é‡Œçš„æ ‡é¢˜å’Œæ—¶é—´
            }, 500);
        }
    }

    function updateCharCount(text) {
        let len = 0;
        if (typeof text === 'string') {
            // å¦‚æœä¼ å…¥ HTML å­—ç¬¦ä¸²ï¼Œå»æ‰æ ‡ç­¾åè®¡æ•°
            const tmp = document.createElement('div'); tmp.innerHTML = text;
            len = tmp.textContent ? tmp.textContent.length : 0;
        } else {
            const el = document.getElementById('noteContentInput');
            len = el ? (el.textContent || '').length : 0;
        }
        document.getElementById('noteCharCount').innerText = `${len} å­—`;
    }

    titleInput.addEventListener('input', handleNoteInput);
    contentInput.addEventListener('input', handleNoteInput);
    // æ”¯æŒç²˜è´´å›¾ç‰‡åˆ°ç¬”è®°ï¼ˆæˆªå›¾æˆ–å¤åˆ¶å›¾ç‰‡å Ctrl+Vï¼‰
    contentInput.addEventListener('paste', function(e) {
        if (userRole !== 'admin') return;
        const items = (e.clipboardData || window.clipboardData).items;
        if (!items) return;
        for (const item of items) {
            if (item.type && item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = function(ev) {
                    insertImageAtCursor(ev.target.result);
                    handleNoteInput();
                };
                reader.readAsDataURL(blob);
                e.preventDefault();
                return;
            }
        }
    });

    // ç‚¹å‡»å›¾ç‰‡æ”¾å¤§ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
    contentInput.addEventListener('click', function(e) {
        const t = e.target;
        if (t && t.tagName === 'IMG') {
            showImagePreview(t.src);
        }
    });

    function insertImageAtCursor(dataUrl) {
        const img = document.createElement('img');
        img.src = dataUrl;
        img.alt = 'pasted-image';
        img.style.maxWidth = '100%';

        const sel = window.getSelection();
        if (!sel || !sel.rangeCount) {
            document.getElementById('noteContentInput').appendChild(img);
            return;
        }
        const range = sel.getRangeAt(0);
        range.deleteContents();
        range.insertNode(img);
        // å°†å…‰æ ‡ç§»åŠ¨åˆ°å›¾ç‰‡ä¹‹å
        range.setStartAfter(img);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
    }

    function showImagePreview(src) {
        const overlay = document.getElementById('imagePreview');
        const img = document.getElementById('imagePreviewImg');
        img.src = src;
        overlay.style.display = 'flex';
    }

    function hideImagePreview() {
        const overlay = document.getElementById('imagePreview');
        overlay.style.display = 'none';
        document.getElementById('imagePreviewImg').src = '';
    }

    // --- 4. å¯¼èˆªæ é€»è¾‘ (ä¿æŒä¸å˜) ---
    function renderAllNav() {
        renderGrid('webGrid', globalData.websites);
        renderGrid('appGrid', globalData.software);
    }
    
    function renderGrid(id, list) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        list.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'nav-item';
            div.draggable = userRole === 'admin'; // åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‹–æ‹½
            div.innerHTML = `<div class="nav-icon">${item.icon}</div><div class="nav-title">${item.title}</div>`;
            div.onclick = (e) => {
                handleOpen(item.url);
            };
            
            // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½çœ‹åˆ°åˆ é™¤æŒ‰é’®
            if (userRole === 'admin') {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'âœ•';
                // åˆ é™¤æŒ‰é’®é€šè¿‡ CSS åœ¨ hover æ—¶æ˜¾ç¤ºï¼Œä¿æŒé»˜è®¤æ ·å¼ä»¥é¿å…å…¨å±€å¯è§
                deleteBtn.onclick = (ev) => {
                    ev.stopPropagation(); // é˜²æ­¢è§¦å‘æ‰“å¼€é“¾æ¥
                    if (confirm('åˆ é™¤?')) { 
                        list.splice(idx, 1); 
                        saveData(); 
                        renderAllNav(); 
                    }
                };
                div.insertBefore(deleteBtn, div.firstChild);
                
                // ç®€å•æ‹–æ‹½
                div.addEventListener('dragstart', (e) => { 
                    div.classList.add('dragging'); 
                    window.dragItem = item; 
                    window.dragList = list; 
                    window.dragIndex = idx;
                    try { e.dataTransfer.setData('text/plain', 'drag'); } catch (err) {}
                });
                div.addEventListener('dragend', () => { 
                    div.classList.remove('dragging'); 
                    // æ¸…ç†ä¸´æ—¶å…¨å±€å˜é‡
                    delete window.dragItem; delete window.dragList; delete window.dragIndex;
                    saveData(); 
                });
            }
            
            el.appendChild(div);
        });
        
        // æ‹–æ‹½æ”¾å…¥é€»è¾‘
        if (userRole === 'admin') {
            el.addEventListener('dragover', e => { e.preventDefault(); });
            // æ ¹æ®é¼ æ ‡ä½ç½®æ‰¾åˆ°è¦æ’å…¥ä¹‹å‰çš„å…ƒç´ 
            function getDragAfterElement(container, x, y) {
                const draggableElements = [...container.querySelectorAll('.nav-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = Math.hypot(x - (box.left + box.width/2), y - (box.top + box.height/2));
                    if (closest === null || offset < closest.offset) {
                        return { offset, element: child };
                    } else return closest;
                }, null);
            }

            el.addEventListener('drop', (e) => {
                e.preventDefault();
                const targetList = list;
                const dragItem = window.dragItem;
                const sourceList = window.dragList;
                const sourceIndex = window.dragIndex;

                if (!dragItem) return;

                // ç§»é™¤åŸå§‹ä½ç½®ï¼ˆæ³¨æ„è‹¥æºä¸ç›®æ ‡ç›¸åŒï¼Œåˆ™å…ˆç§»é™¤å†æ’å…¥é¿å…é‡å¤ï¼‰
                if (sourceList) {
                    const si = sourceList.indexOf(dragItem);
                    if (si !== -1) sourceList.splice(si, 1);
                }

                // æ‰¾åˆ°æœ€æ¥è¿‘çš„ç›®æ ‡å…ƒç´ ï¼Œå¹¶åœ¨å…¶å‰æ’å…¥ï¼›å¦åˆ™è¿½åŠ åˆ°æœ«å°¾
                const after = getDragAfterElement(el, e.clientX, e.clientY);
                if (after && after.element) {
                    const children = Array.from(el.querySelectorAll('.nav-item'));
                    const insertIndex = children.indexOf(after.element);
                    targetList.splice(insertIndex, 0, dragItem);
                } else {
                    targetList.push(dragItem);
                }

                saveData();
                renderAllNav();
            });
        }
    }

    // --- 5. é€šç”¨ç½‘ç»œä¿å­˜ ---
    async function saveData() {
        if (userRole !== 'admin') {
            return; // æ™®é€šç”¨æˆ·ä¸èƒ½ä¿å­˜
        }
        
        await fetch('/api/save_data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(globalData)
        });
    }

    async function handleOpen(path) {
        if (path.startsWith('http')) {
            window.open(path, '_blank');
        } else {
            // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ‰“å¼€æœ¬åœ°åº”ç”¨
            if (userRole === 'admin') {
                fetch('/api/open_app', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({path}) 
                });
            } else {
                showPermissionWarning();
            }
        }
    }

    // --- å¼¹çª—é€»è¾‘ ---
    let addTypeTarget = null;
    function openModal(type) { 
        if (userRole !== 'admin') {
            showPermissionWarning();
            return;
        }
        
        document.getElementById('addModal').style.display = 'flex'; 
        addTypeTarget = type;
        document.getElementById('linkTitle').value='';
        document.getElementById('linkUrl').value='';
        document.getElementById('linkIcon').value='';
    }
    window.closeModal = () => document.getElementById('addModal').style.display='none';
    window.confirmAdd = () => {
        if (userRole !== 'admin') {
            showPermissionWarning();
            return;
        }
        
        const title = document.getElementById('linkTitle').value;
        const url = document.getElementById('linkUrl').value;
        const icon = document.getElementById('linkIcon').value || 'ğŸ”—';
        if(title && url) {
            const list = addTypeTarget === 'websites' ? globalData.websites : globalData.software;
            list.push({title, url, icon});
            saveData(); renderAllNav(); closeModal();
        }
    }

    // åˆ‡æ¢ç¬”è®°æœ¬æ”¾å¤§/è¿˜åŸå¹¶ä¿å­˜åˆ° localStorage
    function toggleNotebookSize() {
        document.body.classList.toggle('notebook-expanded');
        const expanded = document.body.classList.contains('notebook-expanded');
        try { localStorage.setItem('notebookExpanded', expanded ? '1' : '0'); } catch (e) {}
        const btn = document.getElementById('toggleNotebookBtn');
        if (btn) btn.innerText = expanded ? 'ğŸ——' : 'ğŸ”';
    }

    // é¡µé¢åŠ è½½æ—¶æ¢å¤æ”¾å¤§çŠ¶æ€
    (function restoreNotebookSize() {
        try {
            const v = localStorage.getItem('notebookExpanded');
            if (v === '1') {
                document.body.classList.add('notebook-expanded');
            }
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬çŠ¶æ€
            const btn = document.getElementById('toggleNotebookBtn');
            if (btn) {
                const expanded = document.body.classList.contains('notebook-expanded');
                btn.innerText = expanded ? 'ğŸ——' : 'ğŸ”';
            }
        } catch (e) {}
    })();

    // åˆå§‹åŒ–ç¬”è®°æœ¬åˆ†éš”æ¡æ‹–åŠ¨è°ƒæ•´å®½åº¦
    function initNotebookSplitter() {
        const splitter = document.getElementById('notebookSplitter');
        const sidebar = document.querySelector('.note-sidebar');
        const container = document.querySelector('.notebook-container');
        if (!splitter || !sidebar || !container) return;

        let isDragging = false;
        const minW = 140;
        const maxW = Math.max(400, Math.floor(container.clientWidth * 0.8));

        function startDrag(e) {
            isDragging = true;
            document.body.style.userSelect = 'none';
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        }

        function stopDrag() {
            if (!isDragging) return;
            isDragging = false;
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
            try { localStorage.setItem('noteSidebarWidth', parseInt(sidebar.style.width || sidebar.offsetWidth)); } catch (e) {}
        }

        function onMove(clientX) {
            const rect = container.getBoundingClientRect();
            let newWidth = clientX - rect.left;
            newWidth = Math.max(minW, Math.min(maxW, newWidth));
            sidebar.style.width = newWidth + 'px';
        }

        splitter.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', (e) => { if (!isDragging) return; onMove(e.clientX); });
        document.addEventListener('mouseup', stopDrag);

        // touch æ”¯æŒ
        splitter.addEventListener('touchstart', (e) => { startDrag(e.touches[0]); });
        document.addEventListener('touchmove', (e) => { if (!isDragging) return; onMove(e.touches[0].clientX); });
        document.addEventListener('touchend', stopDrag);

        // æ¢å¤å·²ä¿å­˜å®½åº¦
        try {
            const w = localStorage.getItem('noteSidebarWidth');
            if (w) sidebar.style.width = (parseInt(w) || 200) + 'px';
        } catch (e) {}
    }

    window.onload = () => {
        loadData();
                  initMusicPlayer();
          initResize();
          initNotebookSplitter();
          initSearchFunctionality();
      };
  
      // æœç´¢åŠŸèƒ½åˆå§‹åŒ–
      function initSearchFunctionality() {
          const searchInput = document.getElementById('googleSearchInput');
          const searchBtn = document.getElementById('searchBtn');
          const searchSuggestions = document.getElementById('searchSuggestions');
          
          if (!searchInput || !searchBtn) return;
          
          // æ‰§è¡ŒGoogleæœç´¢æˆ–è·³è½¬ç½‘å€
          function performGoogleSearch(query) {
              if (!query || query.trim() === '') return;
              
              const trimmedQuery = query.trim();
              
              // åˆ¤æ–­æ˜¯å¦ä¸ºç½‘å€
              function isWebsite(input) {
                  // æ£€æŸ¥æ˜¯å¦åŒ…å«åè®®å¤´
                  if (input.startsWith('http://') || input.startsWith('https://')) {
                      return true;
                  }
                  // æ£€æŸ¥æ˜¯å¦åŒ…å«åŸŸåæ‰©å±•å
                  const domainPattern = /\.(com|cn|org|net|io|co|dev|app|info|shop|top|xyz|site|online|tech|web|tv|cc|us|uk|au|jp|de|fr|it|es|ru|kr|in|mx|br|ca|edu|gov|mil)+$/i;
                  if (domainPattern.test(input)) {
                      return true;
                  }
                  // æ£€æŸ¥æ˜¯å¦åŒ…å«å†’å·ï¼ˆå¯èƒ½æ˜¯æœ¬åœ°åœ°å€å¦‚localhost:3000ï¼‰
                  if (input.includes(':') && !input.includes(' ')) {
                      return true;
                  }
                  return false;
              }
              
              let targetUrl;
              
              if (isWebsite(trimmedQuery)) {
                  // æ˜¯ç½‘å€ï¼šç›´æ¥è·³è½¬
                  // å¦‚æœæ²¡æœ‰åè®®å¤´ï¼Œæ·»åŠ https://
                  if (!trimmedQuery.startsWith('http://') && !trimmedQuery.startsWith('https://')) {
                      targetUrl = `https://${trimmedQuery}`;
                  } else {
                      targetUrl = trimmedQuery;
                  }
              } else {
                  // æ˜¯æœç´¢è¯ï¼šä½¿ç”¨Googleæœç´¢
                  const encodedQuery = encodeURIComponent(trimmedQuery);
                  targetUrl = `https://www.google.com/search?q=${encodedQuery}`;
              }
              
              // è·³è½¬åˆ°ç›®æ ‡URL
              window.open(targetUrl, '_blank');
              
              // æ¸…ç©ºè¾“å…¥æ¡†
              searchInput.value = '';
              // éšè—å»ºè®®æ¡†
              searchSuggestions.style.display = 'none';
          }
          
          // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
          searchBtn.addEventListener('click', () => {
              performGoogleSearch(searchInput.value);
          });
          
          // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
          searchInput.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                  performGoogleSearch(searchInput.value);
              }
          });
          
          // è¾“å…¥æ¡†èšç„¦äº‹ä»¶ - æ˜¾ç¤ºå»ºè®®
          searchInput.addEventListener('focus', () => {
              if (searchInput.value.trim() === '') {
                  searchSuggestions.style.display = 'block';
              }
          });
          
          // è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶ - åŠ¨æ€æ˜¾ç¤ºå»ºè®®
          searchInput.addEventListener('input', () => {
              const query = searchInput.value.trim();
              if (query === '') {
                  searchSuggestions.style.display = 'block';
              } else {
                  searchSuggestions.style.display = 'none';
              }
          });
          
          // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—å»ºè®®æ¡†
          document.addEventListener('click', (e) => {
              if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                  searchSuggestions.style.display = 'none';
              }
          });
          
          // å»ºè®®é¡¹ç‚¹å‡»äº‹ä»¶
          const suggestionItems = searchSuggestions.querySelectorAll('.search-suggestion-item');
          suggestionItems.forEach(item => {
              item.addEventListener('click', () => {
                  const searchText = item.getAttribute('data-search');
                  searchInput.value = searchText;
                  performGoogleSearch(searchText);
              });
          });
          
          // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶çš„è§†è§‰æ•ˆæœ
          searchInput.addEventListener('focus', () => {
              searchInput.style.borderColor = 'var(--accent-cyan)';
              searchInput.style.boxShadow = '0 0 0 3px rgba(0, 230, 255, 0.25), var(--glow-intensity)';
          });
          
          searchInput.addEventListener('blur', () => {
              searchInput.style.borderColor = 'var(--card-border)';
              searchInput.style.boxShadow = 'var(--shadow-light)';
          });
          
          // æ·»åŠ ä¸€äº›ç§‘æŠ€æ„Ÿç‰¹æ•ˆ
          let pulseInterval;
          searchInput.addEventListener('focus', () => {
              clearInterval(pulseInterval);
              pulseInterval = setInterval(() => {
                  searchBtn.style.transform = `translateY(-50%) scale(${1 + Math.random() * 0.1})`;
              }, 300);
          });
          
          searchInput.addEventListener('blur', () => {
              clearInterval(pulseInterval);
              searchBtn.style.transform = 'translateY(-50%)';
          });
          
          // æ·»åŠ æœç´¢å†å²åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
          const searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
          
          function addToSearchHistory(query) {
              if (!query || query.trim() === '') return;
              
              const trimmedQuery = query.trim();
              // ç§»é™¤é‡å¤é¡¹
              const index = searchHistory.indexOf(trimmedQuery);
              if (index > -1) {
                  searchHistory.splice(index, 1);
              }
              
              // æ·»åŠ åˆ°å¼€å¤´
              searchHistory.unshift(trimmedQuery);
              
              // åªä¿ç•™æœ€è¿‘10æ¡
              if (searchHistory.length > 10) {
                  searchHistory.pop();
              }
              
              localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
          }
          
          // ä¿®æ”¹æœç´¢å‡½æ•°ä»¥ä¿å­˜å†å²
          const originalPerformSearch = performGoogleSearch;
          performGoogleSearch = function(query) {
              addToSearchHistory(query);
              originalPerformSearch(query);
          };
          
          console.log('æœç´¢åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ - ç§‘æŠ€æ„Ÿæœç´¢æ¡†å·²å°±ç»ª');
      }
  </script>
</body>
</html>